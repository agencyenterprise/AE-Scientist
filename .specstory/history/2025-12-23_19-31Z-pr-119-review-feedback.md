<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 4a0ee18b-d739-4cb4-bdcc-be0fd95cf29f (2025-12-23 19:31Z) -->

# Pr 119 review feedback (2025-12-23 19:31Z)

_**User (2025-12-23 14:45Z)**_

@PR 119: Aut 317  can you look at what has changed in this PR and let me know your feedback - any issues, anything that could be simpler, anytingthat you think looks broken etc. I think the local branch should have everything but the PR will help you to focus onthe specific changes that I'm interested in your review for

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user is asking me to review PR 119 related to "Aut 317". They want me to look at what has changed and provide feedback on issues, simplifications, or potential bugs. They mentioned the local branch should have everything, but the PR will help focus on the specific changes.

Let me start by checking the git status and looking at the PR changes. I should look at what's different between the current branch and the main branch to understand what changes are being reviewed.</details></think>

---

I'll help you review PR 119. Let me first check the current git status and then look at the changes in this PR.

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git status && git branch --show-current</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git status && git branch --show-current
```

```
On branch AUT-213
Your branch is ahead of 'origin/AUT-313' by 10 commits.
  (use "git push" to publish your local commits)

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)
	.cursorindexingignore
	.specstory/

nothing added to commit but untracked files present (use "git add" to track)
AUT-213

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git log --oneline -10</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git log --oneline -10
```

```
e216545 Show Completed in Research queue
2b7df53 Tidy PR - remove dead code + refactor for tidyness
f733bce Fix "Stop Run" functionality
ab71ac7 Linting
4d2e7cc small tree adjustments
224ec4e Small text and color updates
684918d Launch Research Directly Navigates to the Research Run + full tree fixes
891d3d1 Full Node Tree + Stage Summary
da8bbb9 Fix "Launch Research" navigation to go directly to new research run
77fd7b6 Small tree viz updates

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me get more context about the PR. I'll look at the diff between the current branch and main to see what's changed. Also, let me check if there's a way to see PR 119 details.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main --stat</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main --stat
```

```
 frontend/package-lock.json                         | 113 ++++----
 frontend/src/app/(dashboard)/layout.tsx            |   2 +-
 frontend/src/app/(dashboard)/page.tsx              |   2 +-
 .../src/app/(dashboard)/research/[runId]/page.tsx  |  38 ++-
 frontend/src/app/layout.tsx                        |   2 +
 .../conversation/components/HowItWorksPanel.tsx    |  53 +++-
 .../conversation/components/IdeationQueueCard.tsx  |  64 +----
 .../conversation/components/InlineIdeaView.tsx     |  28 +-
 .../components/LaunchResearchButton.tsx            |  44 ++++
 .../conversation/hooks/useLaunchResearch.ts        |  67 +++++
 .../input-pipeline/components/HypothesisForm.tsx   |   2 +-
 .../project-draft/hooks/useProjectDraftState.ts    |  13 +-
 .../research/components/ResearchHistoryCard.tsx    |   4 +-
 .../components/research-board-card-body.tsx        |   2 +-
 .../components/run-detail/NodeStrategyGuide.tsx    | 164 ++++++++++++
 .../components/run-detail/NodeTypesLegend.tsx      | 118 +++++++++
 .../run-detail/research-pipeline-stages.tsx        |  52 +---
 .../run-detail/research-run-details-grid.tsx       |  42 +--
 .../components/run-detail/research-run-header.tsx  |  40 +--
 .../components/run-detail/research-run-stats.tsx   |  87 +------
 .../run-detail/research-stage-progress.tsx         |   3 +-
 .../components/run-detail/tree-viz-card.tsx        | 172 +++++++++++--
 .../components/run-detail/tree-viz-viewer.tsx      | 284 ++++++++++++++++++---
 .../research/hooks/useResearchRunDetails.ts        |  46 +++-
 .../features/research/hooks/useResearchRunSSE.ts   |  27 +-
 .../src/features/research/utils/research-utils.tsx |  90 ++++++-
 frontend/src/shared/components/BetaBanner.tsx      |  31 +++
 frontend/src/shared/components/Header.tsx          |   2 +-
 frontend/src/shared/components/Modal.tsx           |  61 +++++
 frontend/src/shared/lib/date-utils.ts              |  43 +++-
 frontend/src/shared/lib/node-strategy-data.ts      | 211 +++++++++++++++
 frontend/src/shared/lib/stage-utils.ts             |  60 +++++
 frontend/src/shared/lib/tree-colors.ts             | 225 ++++++++++++++++
 frontend/src/shared/lib/tree-merge-utils.ts        | 274 ++++++++++++++++++++
 frontend/src/types/api.gen.ts                      | 106 +++++++-
 frontend/src/types/index.ts                        |   2 +
 frontend/src/types/research.ts                     |  45 ++++
 research_pipeline/.env.example                     |   5 +
 .../ai_scientist/telemetry/event_persistence.py    |   1 +
 research_pipeline/ai_scientist/tree_viz_store.py   |  41 ++-
 .../ai_scientist/treesearch/agent_manager.py       |  18 +-
 .../ai_scientist/treesearch/events.py              |   1 +
 .../ai_scientist/treesearch/parallel_agent.py      |  63 +++--
 .../perform_experiments_bfts_with_agentmanager.py  |  28 +-
 .../ai_scientist/treesearch/utils/tree_export.py   |   9 +-
 .../ai_scientist/treesearch/worker_process.py      |  60 ++++-
 server/app/api/public_config.py                    |  14 +
 server/app/api/research_pipeline_events.py         |  49 ++++
 server/app/api/research_pipeline_runs.py           | 100 +++++++-
 server/app/config.py                               |   5 +
 server/app/middleware/auth.py                      |   1 +
 server/app/models/research_pipeline.py             |   6 +-
 server/app/routes.py                               |   2 +
 .../services/database/research_pipeline_runs.py    | 116 ++++-----
 .../research_pipeline/fake_runpod_server.py        |  28 ++
 server/app/services/research_pipeline/monitor.py   |  38 ++-
 .../services/research_pipeline/runpod_manager.py   |   3 +-
 server/openapi.json                                | 112 +++++++-
 server/playground/chatgpt_parser.py                | 194 +++++++-------
 59 files changed, 2853 insertions(+), 660 deletions(-)

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main --name-only</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main --name-only
```

```
frontend/package-lock.json
frontend/src/app/(dashboard)/layout.tsx
frontend/src/app/(dashboard)/page.tsx
frontend/src/app/(dashboard)/research/[runId]/page.tsx
frontend/src/app/layout.tsx
frontend/src/features/conversation/components/HowItWorksPanel.tsx
frontend/src/features/conversation/components/IdeationQueueCard.tsx
frontend/src/features/conversation/components/InlineIdeaView.tsx
frontend/src/features/conversation/components/LaunchResearchButton.tsx
frontend/src/features/conversation/hooks/useLaunchResearch.ts
frontend/src/features/input-pipeline/components/HypothesisForm.tsx
frontend/src/features/project-draft/hooks/useProjectDraftState.ts
frontend/src/features/research/components/ResearchHistoryCard.tsx
frontend/src/features/research/components/research-board-card-body.tsx
frontend/src/features/research/components/run-detail/NodeStrategyGuide.tsx
frontend/src/features/research/components/run-detail/NodeTypesLegend.tsx
frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx
frontend/src/features/research/components/run-detail/research-run-details-grid.tsx
frontend/src/features/research/components/run-detail/research-run-header.tsx
frontend/src/features/research/components/run-detail/research-run-stats.tsx
frontend/src/features/research/components/run-detail/research-stage-progress.tsx
frontend/src/features/research/components/run-detail/tree-viz-card.tsx
frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
frontend/src/features/research/hooks/useResearchRunDetails.ts
frontend/src/features/research/hooks/useResearchRunSSE.ts
frontend/src/features/research/utils/research-utils.tsx
frontend/src/shared/components/BetaBanner.tsx
frontend/src/shared/components/Header.tsx
frontend/src/shared/components/Modal.tsx
frontend/src/shared/lib/date-utils.ts
frontend/src/shared/lib/node-strategy-data.ts
frontend/src/shared/lib/stage-utils.ts
frontend/src/shared/lib/tree-colors.ts
frontend/src/shared/lib/tree-merge-utils.ts
frontend/src/types/api.gen.ts
frontend/src/types/index.ts
frontend/src/types/research.ts
research_pipeline/.env.example
research_pipeline/ai_scientist/telemetry/event_persistence.py
research_pipeline/ai_scientist/tree_viz_store.py
research_pipeline/ai_scientist/treesearch/agent_manager.py
research_pipeline/ai_scientist/treesearch/events.py
research_pipeline/ai_scientist/treesearch/parallel_agent.py
research_pipeline/ai_scientist/treesearch/perform_experiments_bfts_with_agentmanager.py
research_pipeline/ai_scientist/treesearch/utils/tree_export.py
research_pipeline/ai_scientist/treesearch/worker_process.py
server/app/api/public_config.py
server/app/api/research_pipeline_events.py
server/app/api/research_pipeline_runs.py
server/app/config.py
server/app/middleware/auth.py
server/app/models/research_pipeline.py
server/app/routes.py
server/app/services/database/research_pipeline_runs.py
server/app/services/research_pipeline/fake_runpod_server.py
server/app/services/research_pipeline/monitor.py
server/app/services/research_pipeline/runpod_manager.py
server/openapi.json
server/playground/chatgpt_parser.py

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
This is a large PR with many changes. Let me look at the actual diffs for the key files to understand what's being changed. I'll start by looking at the core changes in different areas:

1. Frontend tree visualization changes
2. Backend research pipeline changes
3. New hooks/utilities

Let me read several of the key changed files to understand the PR better.</details></think>

---

Let me look at the key changes in this PR. I'll examine the most important files:

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
```

```
diff --git a/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx b/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
index 69eb8da..4193655 100644
--- a/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
+++ b/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
@@ -1,8 +1,19 @@
 "use client";
 
 import { useEffect, useMemo, useState } from "react";
-import type { ArtifactMetadata, TreeVizItem } from "@/types/research";
+import type { ArtifactMetadata, TreeVizItem, MergedTreeViz, StageZoneMetadata } from "@/types/research";
 import { fetchDownloadUrl } from "@/shared/lib/downloads";
+import { stageLabel } from "@/shared/lib/stage-utils";
+import {
+  getNodeType,
+  getBorderStyle,
+  NODE_TYPE_COLORS,
+  BORDER_STYLES,
+  NODE_TYPE_LONG_DESCRIPTIONS,
+  BorderStyle,
+} from "@/shared/lib/tree-colors";
+import { NodeTypesLegend } from "./NodeTypesLegend";
+import { NodeStrategyGuide } from "./NodeStrategyGuide";
 
 type MetricName = {
   metric_name: string;
@@ -37,24 +48,56 @@ type TreeVizPayload = TreeVizItem["viz"] &amp; {
   exec_time?: Array&lt;number | string | null&gt;;
   exec_time_feedback?: Array&lt;string | null&gt;;
   is_best_node?: Array&lt;boolean&gt;;
+  is_seed_node?: Array&lt;boolean&gt;;
+  is_seed_agg_node?: Array&lt;boolean&gt;;
+  ablation_name?: Array&lt;string | null&gt;;
+  hyperparam_name?: Array&lt;string | null&gt;;
 };
 
 interface Props {
-  viz: TreeVizItem;
+  viz: TreeVizItem | MergedTreeViz;
   artifacts: ArtifactMetadata[];
+  stageId: string;
+  bestNodeId?: number | null;
 }
 
-const NODE_SIZE = 14;
-const BLUE = "#1a73e8";
-const GRAY = "#6b7280";
+const NODE_SIZE = 14; // Reduced from 18 for better density
 
-export function TreeVizViewer({ viz, artifacts }: Props) {
+// SVG sizing configuration
+// These values are calibrated to maintain good aspect ratio and readability:
+// - SINGLE_STAGE_VIEWBOX_HEIGHT: Base height for single-stage tree visualization
+// - ADDITIONAL_HEIGHT_PER_STAGE: Extra height per additional stage in Full Tree view
+//   (33 provides ~1.33x scaling per stage which maintains readable node density)
+// - VIEWBOX_TO_PIXELS_RATIO: Maps viewBox units to CSS pixels
+//   (5x multiplier means viewBox 100 → 500px, giving good resolution)
+const SINGLE_STAGE_VIEWBOX_HEIGHT = 100;
+const ADDITIONAL_HEIGHT_PER_STAGE = 33;
+const VIEWBOX_TO_PIXELS_RATIO = 5;
+
+export function TreeVizViewer({ viz, artifacts, stageId, bestNodeId }: Props) {
   const payload = viz.viz as TreeVizPayload;
-  const [selected, setSelected] = useState&lt;number&gt;(0);
+
+  // Determine initial selection: use bestNodeId if available and valid, otherwise default to 0
+  const initialSelection = useMemo(() =&gt; {
+    if (bestNodeId !== null &amp;&amp; bestNodeId !== undefined &amp;&amp; bestNodeId &gt;= 0) {
+      return bestNodeId;
+    }
+
+    return 0;
+  }, [bestNodeId]);
+
+  const [selected, setSelected] = useState&lt;number&gt;(initialSelection);
+
+  // Reset selection when the viz or bestNodeId changes (e.g., when switching stages)
+  useEffect(() =&gt; {
+    setSelected(initialSelection);
+  }, [initialSelection]);
 
   const nodes = useMemo(() =&gt; {
     return (payload.layout || []).map((coords, idx) =&gt; ({
       id: idx,
+      stageId: (payload as { stageIds?: string[] }).stageIds?.[idx] ?? stageId,
+      originalNodeId: (payload as { originalNodeIds?: number[] }).originalNodeIds?.[idx] ?? idx,
       x: coords?.[0] ?? 0,
       y: coords?.[1] ?? 0,
       code: payload.code?.[idx] ?? "",
@@ -71,11 +114,26 @@ export function TreeVizViewer({ viz, artifacts }: Props) {
       execTime: payload.exec_time?.[idx],
       execTimeFeedback: payload.exec_time_feedback?.[idx] ?? "",
       isBest: payload.is_best_node?.[idx] ?? false,
+      isSeedNode: payload.is_seed_node?.[idx] ?? false,
+      isSeedAggNode: payload.is_seed_agg_node?.[idx] ?? false,
+      ablationName: payload.ablation_name?.[idx],
+      hyperparamName: payload.hyperparam_name?.[idx],
     }));
-  }, [payload]);
+  }, [payload, stageId]);
 
   const edges: Array&lt;[number, number]&gt; = payload.edges ?? [];
 
+  // Extract zone metadata for Full Tree view
+  const zoneMetadata = (payload as { zoneMetadata?: StageZoneMetadata[] }).zoneMetadata ?? [];
+  const isFullTree = stageId === "Full_Tree";
+
+  // Calculate dynamic viewBox height based on number of stages
+  // Full Tree view scales height based on stage count; single stage uses base height
+  const numStages = isFullTree ? zoneMetadata.length : 1;
+  const viewBoxHeight =
+    SINGLE_STAGE_VIEWBOX_HEIGHT + (numStages - 1) * ADDITIONAL_HEIGHT_PER_STAGE;
+  const cssHeight = viewBoxHeight * VIEWBOX_TO_PIXELS_RATIO;
+
   const selectedNode = nodes[selected];
   const plotList = useMemo(() =&gt; {
     if (!selectedNode) return [];
@@ -136,47 +194,161 @@ export function TreeVizViewer({ viz, artifacts }: Props) {
     };
   }, [artifacts, plotList]);
 
+  // Render stage separators (dividers + labels) for Full Tree view
+  const renderStageSeparators = () =&gt; {
+    if (!isFullTree || zoneMetadata.length === 0) return null;
+
+    // Spacing constants (in viewBox units)
+    const LABEL_OFFSET_FROM_TOP = 5.0; // First stage: offset from zone top
+    const LABEL_OFFSET_FROM_DIVIDER = 6.0; // Other stages: offset below divider
+    const DIVIDER_OFFSET = 2.0; // Offset from calculated position
+    const LABEL_BG_HEIGHT = 5;
+    const LABEL_BG_PADDING_TOP = 3.5;
+
+    return (
+      &lt;g className="stage-separators"&gt;
+        {zoneMetadata.map((meta, idx) =&gt; {
+          const isFirstStage = idx === 0;
+          const zoneStartY = meta.zone.min * viewBoxHeight;
+
+          // Position divider in the middle of the padding gap between stages
+          let dividerY = zoneStartY;
+          if (!isFirstStage) {
+            const prevZone = zoneMetadata[idx - 1]?.zone;
+            if (prevZone) {
+              // Divider goes in the middle of the gap: between prevZone.max and meta.zone.min
+              dividerY = ((prevZone.max + meta.zone.min) / 2) * viewBoxHeight;
+            }
+          }
+
+          // Position labels consistently:
+          // - First stage: offset from zone start (no divider above)
+          // - Other stages: offset below divider line
+          const labelY = isFirstStage
+            ? zoneStartY + LABEL_OFFSET_FROM_TOP
+            : dividerY + LABEL_OFFSET_FROM_DIVIDER;
+          const labelText = stageLabel(meta.stageId);
+
+          return (
+            &lt;g key={&#96;separator-${meta.stageId}&#96;}&gt;
+              {/* Background rectangle behind label to prevent node overlap */}
+              &lt;rect
+                x={1}
+                y={labelY - LABEL_BG_PADDING_TOP}
+                width={labelText.length * 2.5}
+                height={LABEL_BG_HEIGHT}
+                fill="#0f172a"
+                opacity={0.9}
+                className="select-none"
+              /&gt;
+
+              {/* Stage label */}
+              &lt;text
+                x={2}
+                y={labelY}
+                fontSize="4"
+                fill="#64748b"
+                fontWeight="600"
+                className="select-none"
+              &gt;
+                {labelText}
+              &lt;/text&gt;
+
+              {/* Divider line (skip first stage, only draw between stages) */}
+              {!isFirstStage &amp;&amp; (
+                &lt;line
+                  x1={0}
+                  y1={dividerY + DIVIDER_OFFSET}
+                  x2={100}
+                  y2={dividerY + DIVIDER_OFFSET}
+                  stroke="#64748b"
+                  strokeWidth={0.4}
+                  strokeDasharray="2,2"
+                  opacity={0.6}
+                /&gt;
+              )}
+            &lt;/g&gt;
+          );
+        })}
+      &lt;/g&gt;
+    );
+  };
+
   return (
     &lt;div className="flex w-full gap-4"&gt;
-      &lt;div className="relative w-1/2 border border-slate-700 bg-slate-900"&gt;
-        &lt;svg viewBox="0 0 100 100" className="w-full h-[320px]"&gt;
-          {edges.map(([parent, child], idx) =&gt; {
-            const p = nodes[parent];
-            const c = nodes[child];
-            if (!p || !c) return null;
-            const px = p.x * 90 + 5;
-            const py = p.y * 90 + 5;
-            const cx = c.x * 90 + 5;
-            const cy = c.y * 90 + 5;
-            return (
-              &lt;line key={idx} x1={px} y1={py} x2={cx} y2={cy} stroke="#cbd5e1" strokeWidth={0.6} /&gt;
-            );
-          })}
-          {nodes.map(node =&gt; {
-            const isSelected = node.id === selected;
-            const color = node.excType ? GRAY : node.isBest ? "#10b981" : BLUE;
-            const cx = node.x * 90 + 5;
-            const cy = node.y * 90 + 5;
-            return (
-              &lt;g key={node.id} onClick={() =&gt; setSelected(node.id)} className="cursor-pointer"&gt;
-                &lt;circle
-                  cx={cx}
-                  cy={cy}
-                  r={NODE_SIZE / 3}
-                  fill={color}
-                  stroke={isSelected ? "#fbbf24" : "#0f172a"}
-                  strokeWidth={isSelected ? 1.2 : 0.6}
+      &lt;div className="w-1/2 flex flex-col"&gt;
+        &lt;div className="relative flex-1 border border-slate-700 bg-slate-900 overflow-auto max-h-[700px]"&gt;
+          &lt;svg
+            viewBox={&#96;0 0 100 ${viewBoxHeight}&#96;}
+            className="w-full"
+            style={{ height: &#96;${cssHeight}px&#96; }}
+          &gt;
+            {/* Stage separators (rendered first as background) */}
+            {renderStageSeparators()}
+
+            {/* Edges */}
+            {edges.map(([parent, child], idx) =&gt; {
+              const p = nodes[parent];
+              const c = nodes[child];
+              if (!p || !c) return null;
+              const px = p.x * 85 + 7.5;
+              const py = p.y * (viewBoxHeight - 15) + 7.5;
+              const cx = c.x * 85 + 7.5;
+              const cy = c.y * (viewBoxHeight - 15) + 7.5;
+              return (
+                &lt;line
+                  key={idx}
+                  x1={px}
+                  y1={py}
+                  x2={cx}
+                  y2={cy}
+                  stroke="#cbd5e1"
+                  strokeWidth={0.48}
                 /&gt;
-              &lt;/g&gt;
-            );
-          })}
-        &lt;/svg&gt;
+              );
+            })}
+            {nodes.map(node =&gt; {
+              const isSelected = node.id === selected;
+              const nodeType = getNodeType(node.id, { nodes, edges });
+              const nodeColor = NODE_TYPE_COLORS[nodeType].color;
+              const qualityBorder = getBorderStyle(node);
+              const borderConfig = BORDER_STYLES[qualityBorder];
+              const selectedBorderConfig = BORDER_STYLES[BorderStyle.Selected];
+              const strokeColor = isSelected ? selectedBorderConfig.stroke : borderConfig.stroke;
+              const strokeWidth = isSelected
+                ? selectedBorderConfig.strokeWidth
+                : borderConfig.strokeWidth;
+              const cx = node.x * 85 + 7.5;
+              const cy = node.y * (viewBoxHeight - 15) + 7.5;
+              return (
+                &lt;g key={node.id} onClick={() =&gt; setSelected(node.id)} className="cursor-pointer"&gt;
+                  &lt;circle
+                    cx={cx}
+                    cy={cy}
+                    r={NODE_SIZE / 3}
+                    fill={nodeColor}
+                    stroke={strokeColor}
+                    strokeWidth={parseFloat(strokeWidth)}
+                  /&gt;
+                &lt;/g&gt;
+              );
+            })}
+          &lt;/svg&gt;
+        &lt;/div&gt;
+        &lt;div className="mt-2 flex gap-2"&gt;
+          &lt;NodeTypesLegend stageId={stageId === "Full_Tree" ? undefined : stageId} /&gt;
+          &lt;NodeStrategyGuide stageId={stageId === "Full_Tree" ? undefined : stageId} /&gt;
+        &lt;/div&gt;
       &lt;/div&gt;
       &lt;div className="w-1/2 rounded border border-slate-700 bg-slate-800 p-3 text-sm text-slate-100 max-h-[600px] overflow-y-auto"&gt;
         {selectedNode ? (
           &lt;&gt;
             &lt;div className="mb-2 flex items-center justify-between"&gt;
-              &lt;h3 className="text-base font-semibold"&gt;Node {selectedNode.id}&lt;/h3&gt;
+              &lt;h3 className="text-base font-semibold"&gt;
+                {selectedNode.stageId
+                  ? &#96;${stageLabel(selectedNode.stageId)}: Node ${selectedNode.originalNodeId + 1}&#96;
+                  : &#96;Node ${selectedNode.id + 1}&#96;}
+              &lt;/h3&gt;
               {selectedNode.excType ? (
                 &lt;span className="text-xs text-red-300"&gt;Abandoned&lt;/span&gt;
               ) : selectedNode.isBest ? (
@@ -186,7 +358,8 @@ export function TreeVizViewer({ viz, artifacts }: Props) {
               )}
             &lt;/div&gt;
             &lt;div className="space-y-2"&gt;
-              &lt;Section label="Plan" value={selectedNode.plan} /&gt;
+              &lt;NodeTypeSection nodeId={selectedNode.id} nodes={nodes} edges={edges} /&gt;
+              {selectedNode.isSeedNode ? null : &lt;Section label="Plan" value={selectedNode.plan} /&gt;}
               &lt;Section label="Analysis" value={selectedNode.analysis} /&gt;
               &lt;MetricsSection metrics={selectedNode.metrics} /&gt;
               &lt;ExecSection
@@ -243,6 +416,33 @@ export function TreeVizViewer({ viz, artifacts }: Props) {
   );
 }
 
+interface NodeTypeSectionProps {
+  nodeId: number;
+  nodes: Array&lt;{
+    id: number;
+    excType?: string | null;
+    isBest?: boolean;
+    isSeedNode?: boolean;
+    isSeedAggNode?: boolean;
+    ablationName?: string | null;
+    hyperparamName?: string | null;
+  }&gt;;
+  edges: Array&lt;[number, number]&gt;;
+}
+
+function NodeTypeSection({ nodeId, nodes, edges }: NodeTypeSectionProps) {
+  const nodeType = getNodeType(nodeId, { nodes, edges });
+  const longDescription = NODE_TYPE_LONG_DESCRIPTIONS[nodeType];
+  const label = NODE_TYPE_COLORS[nodeType].label;
+
+  return (
+    &lt;div&gt;
+      &lt;div className="text-xs font-semibold text-slate-300"&gt;Node Type: {label}&lt;/div&gt;
+      &lt;div className="whitespace-pre-wrap"&gt;{longDescription}&lt;/div&gt;
+    &lt;/div&gt;
+  );
+}
+
 function Section({
   label,
   value,

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/tree-merge-utils.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/tree-merge-utils.ts
```

```
diff --git a/frontend/src/shared/lib/tree-merge-utils.ts b/frontend/src/shared/lib/tree-merge-utils.ts
new file mode 100644
index 0000000..54e8105
--- /dev/null
+++ b/frontend/src/shared/lib/tree-merge-utils.ts
@@ -0,0 +1,274 @@
+import type {
+  TreeVizItem,
+  StageZone,
+  StageZoneMetadata,
+  MergedTreeVizPayload,
+  MergedTreeViz,
+} from "@/types/research";
+
+// Re-export types for consumers that import from this module
+export type { StageZoneMetadata, MergedTreeVizPayload, MergedTreeViz };
+
+/**
+ * Sort stages in chronological order (Stage_1, Stage_2, Stage_3, Stage_4)
+ */
+function sortStages(items: TreeVizItem[]): TreeVizItem[] {
+  const order = ["Stage_1", "Stage_2", "Stage_3", "Stage_4"];
+  return [...items].sort((a, b) =&gt; order.indexOf(a.stage_id) - order.indexOf(b.stage_id));
+}
+
+/**
+ * Calculate vertical zones for each stage
+ * Divides the viewBox into equal zones with padding between stages
+ * Uses adaptive padding: 10% for 1-3 stages, 8% for 4+ stages
+ */
+function calculateStageZones(numStages: number): StageZone[] {
+  if (numStages === 0) return [];
+
+  const zoneHeight = 1.0 / numStages;
+
+  // Adaptive padding: more stages = slightly less padding to preserve tree space
+  const basePadding = 0.1;
+  const padding = numStages &gt;= 4 ? basePadding * 0.8 : basePadding;
+
+  return Array.from({ length: numStages }, (_, i) =&gt; ({
+    min: i * zoneHeight,
+    max: (i + 1) * zoneHeight - padding,
+  }));
+}
+
+/**
+ * Transform layout coordinates to fit within a specific vertical zone
+ */
+function transformLayoutToZone(
+  layout: Array&lt;[number, number]&gt;,
+  zone: StageZone
+): Array&lt;[number, number]&gt; {
+  if (layout.length === 0) return [];
+
+  // Find Y bounds
+  const yValues = layout.map(([, y]) =&gt; y);
+  const minY = Math.min(...yValues);
+  const maxY = Math.max(...yValues);
+  const rangeY = maxY - minY || 1; // Avoid division by zero
+
+  // Transform to zone
+  const zoneRange = zone.max - zone.min;
+
+  return layout.map(([x, y]) =&gt; {
+    const normalizedY = (y - minY) / rangeY; // Normalize to 0-1
+    const transformedY = zone.min + normalizedY * zoneRange;
+    return [x, transformedY];
+  });
+}
+
+/**
+ * Safely concatenate an optional parallel array
+ */
+function concatArray&lt;T&gt;(
+  merged: T[],
+  payload: Record&lt;string, unknown&gt;,
+  key: string,
+  defaultValue: T
+): void {
+  const array = payload[key] as T[] | undefined;
+  if (array &amp;&amp; Array.isArray(array)) {
+    merged.push(...array);
+  } else {
+    // If array doesn't exist, fill with default values based on layout length
+    const layoutLength = (payload.layout as Array&lt;unknown&gt;)?.length ?? 0;
+    merged.push(...Array(layoutLength).fill(defaultValue));
+  }
+}
+
+/**
+ * Merge multiple TreeVizItem objects into a single unified tree
+ */
+export function mergeTreeVizItems(items: TreeVizItem[]): MergedTreeViz | null {
+  if (items.length === 0) return null;
+
+  // Sort stages chronologically
+  const sorted = sortStages(items);
+
+  // Calculate vertical zones
+  const stageZones = calculateStageZones(sorted.length);
+
+  // Initialize merged payload
+  const merged: MergedTreeVizPayload = {
+    layout: [],
+    edges: [],
+    stageIds: [],
+    originalNodeIds: [],
+    zoneMetadata: [],
+    code: [],
+    plan: [],
+    analysis: [],
+    metrics: [],
+    exc_type: [],
+    exc_info: [],
+    exc_stack: [],
+    plot_plan: [],
+    plot_code: [],
+    plot_analyses: [],
+    plots: [],
+    plot_paths: [],
+    vlm_feedback_summary: [],
+    datasets_successfully_tested: [],
+    exec_time: [],
+    exec_time_feedback: [],
+    is_best_node: [],
+    is_seed_node: [],
+    is_seed_agg_node: [],
+    ablation_name: [],
+    hyperparam_name: [],
+  };
+
+  let globalNodeIndex = 0;
+
+  // Track processed stages with their metadata
+  const processedStages: Array&lt;{
+    stageId: string;
+    stageIdx: number;
+    globalOffset: number;
+    nodeCount: number;
+    payload: Record&lt;string, unknown&gt;;
+  }&gt; = [];
+
+  // Merge each stage
+  for (let stageIdx = 0; stageIdx &lt; sorted.length; stageIdx++) {
+    const item = sorted[stageIdx];
+    const zone = stageZones[stageIdx];
+    if (!item || !zone) continue;
+
+    const payload = item.viz as Record&lt;string, unknown&gt;;
+
+    const layout = payload.layout as Array&lt;[number, number]&gt; | undefined;
+    if (!layout || layout.length === 0) {
+      // Skip empty stages
+      continue;
+    }
+
+    // Add zone metadata for this stage
+    if (merged.zoneMetadata) {
+      merged.zoneMetadata.push({
+        stageIndex: stageIdx,
+        stageId: item.stage_id,
+        zone: zone,
+      });
+    }
+
+    // Transform layout coordinates to fit in this stage's zone
+    const transformedLayout = transformLayoutToZone(layout, zone);
+
+    // Reindex edges to point to global node indices
+    const edges = (payload.edges as Array&lt;[number, number]&gt;) || [];
+    const offsetEdges = edges.map(
+      ([parent, child]) =&gt; [parent + globalNodeIndex, child + globalNodeIndex] as [number, number]
+    );
+
+    // Merge layout and edges
+    merged.layout.push(...transformedLayout);
+    merged.edges.push(...offsetEdges);
+
+    // Track stage info for each node
+    const nodeCount = layout.length;
+    merged.stageIds.push(...Array(nodeCount).fill(item.stage_id));
+    merged.originalNodeIds.push(...Array.from({ length: nodeCount }, (_, i) =&gt; i));
+
+    // Merge all parallel arrays
+    if (merged.code) concatArray(merged.code, payload, "code", "");
+    if (merged.plan) concatArray(merged.plan, payload, "plan", "");
+    if (merged.analysis) concatArray(merged.analysis, payload, "analysis", "");
+    if (merged.metrics) concatArray(merged.metrics, payload, "metrics", null);
+    if (merged.exc_type) concatArray(merged.exc_type, payload, "exc_type", null);
+    if (merged.exc_info) concatArray(merged.exc_info, payload, "exc_info", null);
+    if (merged.exc_stack) concatArray(merged.exc_stack, payload, "exc_stack", null);
+    if (merged.plot_plan) concatArray(merged.plot_plan, payload, "plot_plan", null);
+    if (merged.plot_code) concatArray(merged.plot_code, payload, "plot_code", null);
+    if (merged.plot_analyses) concatArray(merged.plot_analyses, payload, "plot_analyses", null);
+    if (merged.plots) concatArray(merged.plots, payload, "plots", null);
+    if (merged.plot_paths) concatArray(merged.plot_paths, payload, "plot_paths", null);
+    if (merged.vlm_feedback_summary) {
+      concatArray(merged.vlm_feedback_summary, payload, "vlm_feedback_summary", null);
+    }
+    if (merged.datasets_successfully_tested) {
+      concatArray(
+        merged.datasets_successfully_tested,
+        payload,
+        "datasets_successfully_tested",
+        null
+      );
+    }
+    if (merged.exec_time) concatArray(merged.exec_time, payload, "exec_time", null);
+    if (merged.exec_time_feedback) {
+      concatArray(merged.exec_time_feedback, payload, "exec_time_feedback", null);
+    }
+    if (merged.is_best_node) concatArray(merged.is_best_node, payload, "is_best_node", false);
+    if (merged.is_seed_node) concatArray(merged.is_seed_node, payload, "is_seed_node", false);
+    if (merged.is_seed_agg_node) {
+      concatArray(merged.is_seed_agg_node, payload, "is_seed_agg_node", false);
+    }
+    if (merged.ablation_name) concatArray(merged.ablation_name, payload, "ablation_name", null);
+    if (merged.hyperparam_name) {
+      concatArray(merged.hyperparam_name, payload, "hyperparam_name", null);
+    }
+
+    // Record this stage's metadata for inter-stage connections
+    processedStages.push({
+      stageId: item.stage_id,
+      stageIdx: stageIdx,
+      globalOffset: globalNodeIndex,
+      nodeCount: nodeCount,
+      payload: payload,
+    });
+
+    globalNodeIndex += nodeCount;
+  }
+
+  // Connect stages: best node of Stage N → root node of Stage N+1
+  for (let i = 0; i &lt; processedStages.length - 1; i++) {
+    const currentStage = processedStages[i];
+    const nextStage = processedStages[i + 1];
+    if (!currentStage || !nextStage) continue;
+
+    // Find best node in current stage
+    const isBestArray = currentStage.payload.is_best_node as boolean[] | undefined;
+    const bestNodeLocalIdx = isBestArray?.findIndex(b =&gt; b === true) ?? -1;
+
+    if (bestNodeLocalIdx &lt; 0) continue; // Skip if no best node
+
+    // Find root node in next stage (node with no incoming edges)
+    const nextEdges = (nextStage.payload.edges as Array&lt;[number, number]&gt;) || [];
+    const hasIncoming = new Set(nextEdges.map(([, child]) =&gt; child));
+
+    let rootNodeLocalIdx = -1;
+    for (let j = 0; j &lt; nextStage.nodeCount; j++) {
+      if (!hasIncoming.has(j)) {
+        rootNodeLocalIdx = j;
+        break;
+      }
+    }
+
+    if (rootNodeLocalIdx &lt; 0) continue; // Skip if no root found
+
+    // Add connection edge (global indices)
+    const bestNodeGlobal = currentStage.globalOffset + bestNodeLocalIdx;
+    const rootNodeGlobal = nextStage.globalOffset + rootNodeLocalIdx;
+    merged.edges.push([bestNodeGlobal, rootNodeGlobal]);
+  }
+
+  // Return merged tree viz
+  const firstItem = sorted[0];
+  const lastItem = sorted[sorted.length - 1];
+  if (!firstItem || !lastItem) return null;
+
+  return {
+    id: -1, // Synthetic ID
+    run_id: firstItem.run_id,
+    stage_id: "Full_Tree",
+    version: 1,
+    viz: merged,
+    created_at: firstItem.created_at,
+    updated_at: lastItem.updated_at,
+  };
+}

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/conversation/hooks/useLaunchResearch.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/conversation/hooks/useLaunchResearch.ts
```

```
diff --git a/frontend/src/features/conversation/hooks/useLaunchResearch.ts b/frontend/src/features/conversation/hooks/useLaunchResearch.ts
new file mode 100644
index 0000000..74c69f0
--- /dev/null
+++ b/frontend/src/features/conversation/hooks/useLaunchResearch.ts
@@ -0,0 +1,67 @@
+import { useState } from "react";
+import { useRouter } from "next/navigation";
+import { apiFetch, ApiError } from "@/shared/lib/api-client";
+import { parseInsufficientCreditsError } from "@/shared/utils/credits";
+import type { ResearchRunAcceptedResponse } from "@/types";
+
+/**
+ * Custom hook for launching research from an idea
+ * Handles modal state, API calls, and error handling
+ */
+export function useLaunchResearch(conversationId: number | null) {
+  const router = useRouter();
+  const [isLaunchModalOpen, setIsLaunchModalOpen] = useState(false);
+  const [isLaunching, setIsLaunching] = useState(false);
+
+  const handleLaunchClick = () =&gt; {
+    setIsLaunchModalOpen(true);
+  };
+
+  const handleConfirmLaunch = async (): Promise&lt;void&gt; =&gt; {
+    if (!conversationId) return;
+    setIsLaunching(true);
+    try {
+      const response = await apiFetch&lt;ResearchRunAcceptedResponse&gt;(
+        &#96;/conversations/${conversationId}/idea/research-run&#96;,
+        {
+          method: "POST",
+        }
+      );
+      setIsLaunchModalOpen(false);
+      router.push(&#96;/research/${response.run_id}&#96;);
+    } catch (error) {
+      if (error instanceof ApiError) {
+        if (error.status === 402) {
+          const info = parseInsufficientCreditsError(error.data);
+          const message =
+            info?.message ||
+            (info?.required
+              ? &#96;You need at least ${info.required} credits to launch research.&#96;
+              : "Insufficient credits to launch research.");
+          throw new Error(message);
+        }
+        if (error.status === 400) {
+          const detailValue =
+            error.data &amp;&amp;
+            typeof error.data === "object" &amp;&amp;
+            typeof (error.data as { detail?: unknown }).detail === "string"
+              ? (error.data as { detail: string }).detail
+              : undefined;
+          const message = detailValue ?? "Failed to launch research run.";
+          throw new Error(message);
+        }
+      }
+      throw error;
+    } finally {
+      setIsLaunching(false);
+    }
+  };
+
+  return {
+    isLaunchModalOpen,
+    setIsLaunchModalOpen,
+    isLaunching,
+    handleLaunchClick,
+    handleConfirmLaunch,
+  };
+}

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me continue reviewing more key files to understand the changes better. I'll look at more components and the backend changes.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/tree-colors.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/tree-colors.ts
```

```
diff --git a/frontend/src/shared/lib/tree-colors.ts b/frontend/src/shared/lib/tree-colors.ts
new file mode 100644
index 0000000..8ae5c3a
--- /dev/null
+++ b/frontend/src/shared/lib/tree-colors.ts
@@ -0,0 +1,225 @@
+/**
+ * Tree visualization color and styling configuration
+ * Centralized configuration for node colors and border styles
+ */
+
+export enum NodeType {
+  Root = "root",
+  Debug = "debug",
+  Improve = "improve",
+  Hyperparam = "hyperparam",
+  Ablation = "ablation",
+  SeedNode = "seed_node",
+}
+
+export enum BorderStyle {
+  Normal = "normal",
+  Best = "best",
+  Failed = "failed",
+  Selected = "selected",
+}
+
+interface NodeTypeConfig {
+  color: string;
+  label: string;
+}
+
+interface NodeColors {
+  [NodeType.Root]: NodeTypeConfig;
+  [NodeType.Debug]: NodeTypeConfig;
+  [NodeType.Improve]: NodeTypeConfig;
+  [NodeType.Hyperparam]: NodeTypeConfig;
+  [NodeType.Ablation]: NodeTypeConfig;
+  [NodeType.SeedNode]: NodeTypeConfig;
+}
+
+interface BorderConfig {
+  stroke: string;
+  strokeWidth: string;
+}
+
+interface BorderStyles {
+  [BorderStyle.Normal]: BorderConfig;
+  [BorderStyle.Best]: BorderConfig;
+  [BorderStyle.Failed]: BorderConfig;
+  [BorderStyle.Selected]: BorderConfig;
+}
+
+/**
+ * Node type colors - consistent across all stages
+ * Customize these colors to change how node types appear in the visualization
+ */
+export const NODE_TYPE_COLORS: NodeColors = {
+  [NodeType.Root]: {
+    color: "#1E40AF", // Darker blue
+    label: "Root Node",
+  },
+  [NodeType.Debug]: {
+    color: "#6366F1", // Indigo - neutral, distinct from failure status
+    label: "Debug",
+  },
+  [NodeType.Improve]: {
+    color: "#0284C7", // Sky blue
+    label: "Improve",
+  },
+  [NodeType.Hyperparam]: {
+    color: "#A855F7", // Purple
+    label: "Hyperparameter Tuning",
+  },
+  [NodeType.Ablation]: {
+    color: "#D97706", // Orange
+    label: "Ablation Study",
+  },
+  [NodeType.SeedNode]: {
+    color: "#92400E", // Brown
+    label: "Seed Node",
+  },
+};
+
+/**
+ * Border styles - indicate node quality/status
+ * Adjust strokeWidth values to make borders more/less prominent in the visualization
+ */
+export const BORDER_STYLES: BorderStyles = {
+  [BorderStyle.Normal]: {
+    stroke: "#0f172a",
+    strokeWidth: "1.2",
+  },
+  [BorderStyle.Best]: {
+    stroke: "#065F46",
+    strokeWidth: "1.2",
+  },
+  [BorderStyle.Failed]: {
+    stroke: "#DC2626",
+    strokeWidth: "1.2",
+  },
+  [BorderStyle.Selected]: {
+    stroke: "#fbbf24",
+    strokeWidth: "1.2",
+  },
+};
+
+interface Node {
+  excType?: string | null;
+  isBest?: boolean;
+  isSeedNode?: boolean;
+  isSeedAggNode?: boolean;
+  ablationName?: string | null;
+  hyperparamName?: string | null;
+}
+
+interface NodesContext {
+  nodes: Array&lt;Node&gt;;
+  edges: Array&lt;[number, number]&gt;;
+}
+
+/**
+ * Infer node type from node properties
+ */
+export function getNodeType(nodeIdx: number, context: NodesContext): NodeType {
+  const node = context.nodes[nodeIdx];
+  if (!node) return NodeType.Improve;
+
+  // Check explicit type flags first
+  if (node.isSeedNode) return NodeType.SeedNode;
+  if (node.ablationName) return NodeType.Ablation;
+  if (node.hyperparamName) return NodeType.Hyperparam;
+
+  // Determine Root vs Debug vs Improve from parent relationships
+  const parentIdx = context.edges.find(([, child]) =&gt; child === nodeIdx)?.[0];
+
+  if (parentIdx === undefined) {
+    // No incoming edge = Root node
+    return NodeType.Root;
+  }
+
+  // Has parent - check if parent is buggy
+  const parentNode = context.nodes[parentIdx];
+  if (parentNode?.excType) {
+    // Parent failed = this node is attempting to debug
+    return NodeType.Debug;
+  }
+
+  // Parent succeeded = this node is an improvement
+  return NodeType.Improve;
+}
+
+/**
+ * Determine border style based on node quality
+ */
+export function getBorderStyle(node: Node): BorderStyle {
+  if (node.excType) return BorderStyle.Failed;
+  if (node.isBest) return BorderStyle.Best;
+  return BorderStyle.Normal;
+}
+
+/**
+ * Get stage-relevant node types
+ * Returns only node types that can appear in a given stage
+ */
+export function getStageRelevantNodeTypes(stageId?: string): NodeType[] {
+  if (!stageId) return Object.values(NodeType);
+
+  // Normalize stage_id (e.g., "Stage_1" or "stage_1")
+  const stageNum = stageId.toLowerCase().includes("stage_1")
+    ? 1
+    : stageId.toLowerCase().includes("stage_2")
+      ? 2
+      : stageId.toLowerCase().includes("stage_3")
+        ? 3
+        : stageId.toLowerCase().includes("stage_4")
+          ? 4
+          : null;
+
+  if (!stageNum) return Object.values(NodeType);
+
+  switch (stageNum) {
+    case 1:
+      return [NodeType.Root, NodeType.Debug, NodeType.Improve, NodeType.SeedNode];
+    case 2:
+      return [
+        NodeType.Root,
+        NodeType.Debug,
+        NodeType.Improve,
+        NodeType.Hyperparam,
+        NodeType.SeedNode,
+      ];
+    case 3:
+      return [NodeType.Debug, NodeType.Improve, NodeType.SeedNode];
+    case 4:
+      return [NodeType.Improve, NodeType.Ablation, NodeType.SeedNode];
+    default:
+      return Object.values(NodeType);
+  }
+}
+
+/**
+ * Get descriptions for each node type (without stage mentions)
+ */
+export const NODE_TYPE_DESCRIPTIONS: Record&lt;NodeType, string&gt; = {
+  [NodeType.Root]: "Initial baseline implementation",
+  [NodeType.Debug]: "Attempts to fix bugs in failed implementations",
+  [NodeType.Improve]: "Optimizations/refinements of working code",
+  [NodeType.Hyperparam]: "Systematic parameter exploration",
+  [NodeType.Ablation]: "Component contribution analysis",
+  [NodeType.SeedNode]: "Robustness testing with different random seeds",
+};
+
+/**
+ * Long descriptions for each node type
+ * Used in the detail panel to explain what the scientist is trying to do
+ */
+export const NODE_TYPE_LONG_DESCRIPTIONS: Record&lt;NodeType, string&gt; = {
+  [NodeType.Root]:
+    "The starting implementation that establishes the baseline. This is the initial attempt to solve the research problem.",
+  [NodeType.Debug]:
+    "The scientist identified a bug or failure in the parent implementation and generated a fix. These nodes represent debugging attempts to get the code working again.",
+  [NodeType.Improve]:
+    "The parent implementation succeeded, and this node represents an attempt to improve performance or quality. The scientist applies optimizations while maintaining functionality.",
+  [NodeType.Hyperparam]:
+    "Systematic exploration of hyperparameter values to find better configurations. The scientist varies parameters within the same general approach.",
+  [NodeType.Ablation]:
+    "Controlled removal of specific components to understand their individual contributions. The scientist isolates which parts of the code are most important.",
+  [NodeType.SeedNode]:
+    "Tests the robustness of the parent's implementation by running it with different random seeds. Unlike debug/improve nodes, this reuses the parent code with varied initialization.",
+};

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/stage-utils.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/stage-utils.ts
```

```
diff --git a/frontend/src/shared/lib/stage-utils.ts b/frontend/src/shared/lib/stage-utils.ts
new file mode 100644
index 0000000..4378396
--- /dev/null
+++ b/frontend/src/shared/lib/stage-utils.ts
@@ -0,0 +1,60 @@
+import type { SubstageSummary } from "@/types/research";
+
+/**
+ * Convert stage ID to human-readable label
+ * Example: "Stage_1" → "Stage 1"
+ */
+export function stageLabel(stageId: string): string {
+  return stageId.replace("Stage_", "Stage ");
+}
+
+/**
+ * Type guard to check if a value is a Record object
+ */
+export function isRecord(value: unknown): value is Record&lt;string, unknown&gt; {
+  return typeof value === "object" &amp;&amp; value !== null &amp;&amp; !Array.isArray(value);
+}
+
+/**
+ * Extract stage slug from backend stage name
+ *
+ * Backend format: {stage_number}_{stage_slug}[_{substage_number}_{substage_slug}...]
+ * Examples:
+ *   "1_initial_implementation" → "initial_implementation"
+ *   "2_baseline_tuning_2_optimization" → "baseline_tuning"
+ *   "3_creative_research_1_exploration" → "creative_research"
+ */
+export function extractStageSlug(stageName: string): string | null {
+  const parts = stageName.split("_");
+
+  // Need at least 2 parts: stage_number + slug
+  if (parts.length &lt; 2) return null;
+
+  // Skip first part (stage number), collect parts until we hit next number (substage number)
+  const slugParts: string[] = [];
+  for (let i = 1; i &lt; parts.length; i++) {
+    const part = parts[i];
+    if (!part) continue;
+    // Stop when we hit a number (substage number)
+    if (/^\d+$/.test(part)) break;
+    slugParts.push(part);
+  }
+
+  return slugParts.length &gt; 0 ? slugParts.join("_") : null;
+}
+
+/**
+ * Extract display text from a SubstageSummary
+ * Prefers the llm_summary field if available, otherwise JSON stringifies the summary
+ */
+export function getSummaryText(summary: SubstageSummary): string {
+  if (!isRecord(summary.summary)) {
+    return JSON.stringify(summary.summary, null, 2);
+  }
+  const llmSummary = summary.summary.llm_summary;
+  if (typeof llmSummary === "string" &amp;&amp; llmSummary.trim().length &gt; 0) {
+    return llmSummary.trim();
+  }
+  return JSON.stringify(summary.summary, null, 2);
+}
+

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/tree-viz-card.tsx
```

```
diff --git a/frontend/src/features/research/components/run-detail/tree-viz-card.tsx b/frontend/src/features/research/components/run-detail/tree-viz-card.tsx
index 89be2c9..fae4041 100644
--- a/frontend/src/features/research/components/run-detail/tree-viz-card.tsx
+++ b/frontend/src/features/research/components/run-detail/tree-viz-card.tsx
@@ -1,39 +1,134 @@
 "use client";
 
 import { useMemo, useState } from "react";
-import type { TreeVizItem, ArtifactMetadata } from "@/types/research";
+import type { TreeVizItem, ArtifactMetadata, SubstageSummary } from "@/types/research";
+import { formatDateTime } from "@/shared/lib/date-utils";
+import { stageLabel, extractStageSlug, getSummaryText } from "@/shared/lib/stage-utils";
 import { TreeVizViewer } from "./tree-viz-viewer";
+import { mergeTreeVizItems } from "@/shared/lib/tree-merge-utils";
 
 interface Props {
   treeViz?: TreeVizItem[] | null;
   conversationId: number | null;
   artifacts: ArtifactMetadata[];
+  substageSummaries?: SubstageSummary[];
 }
 
-export function TreeVizCard({ treeViz, conversationId, artifacts }: Props) {
+const FULL_TREE_ID = "Full_Tree";
+
+const STAGE_SUMMARIES: Record&lt;string, string&gt; = {
+  Stage_1:
+    "Goal: Develop functional code which can produce a runnable result. The tree represents attempts and fixes needed to reach this state.",
+  Stage_2:
+    "Goal: Improve the baseline through tuning and small changes to the code while keeping the overall approach fixed. The scientist tries to improve the metrics which quantify the quality of the research.",
+  Stage_3:
+    "Goal: Explore higher-leverage variants and research directions, supported by plots and analyses to understand what is driving performance. The scientist tries to find and validate meaningful improvements worth writing up.",
+  Stage_4:
+    "Goal: Run controlled ablations and robustness checks to isolate which components matter and why. The scientist tries to attribute gains and strengthen the evidence for the final claims.",
+  [FULL_TREE_ID]:
+    "Combined view showing all stages of the research pipeline stacked vertically in chronological order.",
+};
+
+const STAGE_ID_TO_STAGE_KEY: Record&lt;string, string&gt; = {
+  Stage_1: "initial_implementation",
+  Stage_2: "baseline_tuning",
+  Stage_3: "creative_research",
+  Stage_4: "ablation_studies",
+};
+
+export function TreeVizCard({ treeViz, conversationId, artifacts, substageSummaries }: Props) {
   const list = useMemo(() =&gt; treeViz ?? [], [treeViz]);
   const hasViz = list.length &gt; 0 &amp;&amp; conversationId !== null;
 
-  // User selection - null means use default (first item)
-  const [userSelectedStageId, setUserSelectedStageId] = useState&lt;string | null&gt;(null);
+  // Track whether user has manually selected a stage (null = auto-follow mode)
+  const [manuallySelectedStageId, setManuallySelectedStageId] = useState&lt;string | null&gt;(null);
 
-  // Derived selected stage ID - falls back to first item if user selection is invalid
+  // Compute the most recent stage ID
+  const mostRecentStageId = useMemo(() =&gt; {
+    if (!hasViz) return null;
+    const sortedByDate = [...list].sort(
+      (a, b) =&gt; new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()
+    );
+    return sortedByDate[0]?.stage_id ?? null;
+  }, [hasViz, list]);
+
+  // Derived selected stage ID - uses manual selection if set, otherwise auto-follows most recent
   const selectedStageId = useMemo(() =&gt; {
     if (!hasViz) return null;
-    // If user has selected a valid stage, use it
-    if (userSelectedStageId &amp;&amp; list.find(v =&gt; v.stage_id === userSelectedStageId)) {
-      return userSelectedStageId;
+
+    // If user has manually selected Full Tree or a stage that still exists, use it
+    if (manuallySelectedStageId) {
+      if (manuallySelectedStageId === FULL_TREE_ID) {
+        return FULL_TREE_ID;
+      }
+      if (list.find(v =&gt; v.stage_id === manuallySelectedStageId)) {
+        return manuallySelectedStageId;
+      }
+    }
+
+    // Otherwise auto-follow the most recent stage
+    return mostRecentStageId;
+  }, [hasViz, list, manuallySelectedStageId, mostRecentStageId]);
+
+  // Create merged viz for Full Tree view
+  const mergedViz = useMemo(() =&gt; {
+    if (!hasViz || list.length === 0) return null;
+    return mergeTreeVizItems(list);
+  }, [hasViz, list]);
+
+  const selectedViz = useMemo(() =&gt; {
+    if (!hasViz || !selectedStageId) return null;
+    if (selectedStageId === FULL_TREE_ID) return mergedViz;
+    return list.find(v =&gt; v.stage_id === selectedStageId) ?? list[0];
+  }, [hasViz, selectedStageId, list, mergedViz]);
+
+  // Find best node for the selected stage using the is_best_node array in the tree viz payload
+  const bestNodeForSelectedStage = useMemo(() =&gt; {
+    if (!selectedViz) {
+      return null;
     }
-    // Otherwise default to first item
-    return list[0]?.stage_id ?? null;
-  }, [hasViz, list, userSelectedStageId]);
 
-  const selectedViz =
-    hasViz &amp;&amp; selectedStageId ? (list.find(v =&gt; v.stage_id === selectedStageId) ?? list[0]) : null;
+    // eslint-disable-next-line @typescript-eslint/no-explicit-any
+    const payload = selectedViz.viz as any;
+    const isBestNodeArray = payload?.is_best_node;
+
+    if (!isBestNodeArray || isBestNodeArray.length === 0) {
+      return null;
+    }
+
+    // Find the index where is_best_node is true
+    const bestNodeIndex = isBestNodeArray.findIndex((isBest: boolean) =&gt; isBest === true);
+
+    return bestNodeIndex &gt;= 0 ? bestNodeIndex : null;
+  }, [selectedViz]);
+
+  const stageSummaryText = useMemo(() =&gt; {
+    if (!selectedViz) return null;
+    if (!substageSummaries || substageSummaries.length === 0) return null;
+    if (selectedViz.stage_id === FULL_TREE_ID) return null;
+
+    const stageKey = STAGE_ID_TO_STAGE_KEY[selectedViz.stage_id];
+    if (!stageKey) return null;
+
+    const matches = substageSummaries.filter(
+      summary =&gt; extractStageSlug(summary.stage) === stageKey
+    );
+    if (matches.length === 0) return null;
+
+    const latest =
+      matches.sort(
+        (a, b) =&gt; new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
+      )[0] ?? null;
+    if (!latest) return null;
+
+    return getSummaryText(latest);
+  }, [selectedViz, substageSummaries]);
 
   return (
     &lt;div className="w-full rounded-lg border border-slate-800 bg-slate-900/60 p-4"&gt;
-      &lt;div className="mb-2 text-sm font-semibold text-slate-100"&gt;Tree Visualization&lt;/div&gt;
+      &lt;div className="mb-2"&gt;
+        &lt;span className="text-sm font-semibold text-slate-100"&gt;Tree Visualization&lt;/span&gt;
+      &lt;/div&gt;
       {!hasViz &amp;&amp; &lt;p className="text-sm text-slate-300"&gt;No tree visualization available yet.&lt;/p&gt;}
       {hasViz &amp;&amp; selectedViz &amp;&amp; (
         &lt;&gt;
@@ -42,24 +137,61 @@ export function TreeVizCard({ treeViz, conversationId, artifacts }: Props) {
               &lt;button
                 key={&#96;${viz.stage_id}-${viz.id}&#96;}
                 type="button"
-                onClick={() =&gt; setUserSelectedStageId(viz.stage_id)}
+                onClick={() =&gt; {
+                  setManuallySelectedStageId(viz.stage_id);
+                }}
                 className={&#96;rounded px-3 py-1 text-xs ${
                   viz.stage_id === selectedStageId
                     ? "bg-emerald-500 text-slate-900"
                     : "bg-slate-800 text-slate-200 hover:bg-slate-700"
                 }&#96;}
               &gt;
-                {viz.stage_id.replace("Stage_", "Stage ")}
+                {stageLabel(viz.stage_id)}
               &lt;/button&gt;
             ))}
+            &lt;button
+              key="full-tree"
+              type="button"
+              onClick={() =&gt; {
+                setManuallySelectedStageId(FULL_TREE_ID);
+              }}
+              className={&#96;rounded px-3 py-1 text-xs ${
+                selectedStageId === FULL_TREE_ID
+                  ? "bg-emerald-500 text-slate-900"
+                  : "bg-slate-800 text-slate-200 hover:bg-slate-700"
+              }&#96;}
+            &gt;
+              Full Tree
+            &lt;/button&gt;
           &lt;/div&gt;
-          &lt;div className="flex items-center justify-between text-xs text-slate-400 mb-2"&gt;
+          &lt;p className="mb-2 text-xs text-slate-300"&gt;
+            {STAGE_SUMMARIES[selectedViz.stage_id] ?? ""}
+          &lt;/p&gt;
+          {stageSummaryText &amp;&amp; (
+            &lt;div className="mb-2 w-full rounded border border-slate-800/60 bg-slate-900/60 p-3"&gt;
+              &lt;p className="text-[11px] font-semibold uppercase tracking-wide text-slate-400"&gt;
+                Completed Stage Summary
+              &lt;/p&gt;
+              &lt;div className="mt-1 text-xs leading-relaxed text-slate-200 whitespace-pre-wrap"&gt;
+                {stageSummaryText}
+              &lt;/div&gt;
+            &lt;/div&gt;
+          )}
+          &lt;div className="mb-2 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-slate-400"&gt;
+            &lt;span&gt;
+              &lt;span className="text-slate-500"&gt;Start:&lt;/span&gt;{" "}
+              {formatDateTime(selectedViz.created_at)}
+            &lt;/span&gt;
             &lt;span&gt;
-              Stage {selectedViz.stage_id} • Version {selectedViz.version} •{" "}
-              {new Date(selectedViz.updated_at).toLocaleString()}
+              &lt;span className="text-slate-500"&gt;End:&lt;/span&gt; {formatDateTime(selectedViz.updated_at)}
             &lt;/span&gt;
           &lt;/div&gt;
-          &lt;TreeVizViewer viz={selectedViz} artifacts={artifacts} /&gt;
+          &lt;TreeVizViewer
+            viz={selectedViz}
+            artifacts={artifacts}
+            stageId={selectedViz.stage_id}
+            bestNodeId={bestNodeForSelectedStage}
+          /&gt;
         &lt;/&gt;
       )}
     &lt;/div&gt;

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me continue checking more files, especially the backend changes and some of the research pipeline changes. I'll also look at the new components and hooks.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/hooks/useResearchRunDetails.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/hooks/useResearchRunDetails.ts
```

```
diff --git a/frontend/src/features/research/hooks/useResearchRunDetails.ts b/frontend/src/features/research/hooks/useResearchRunDetails.ts
index bc30b20..2e24f69 100644
--- a/frontend/src/features/research/hooks/useResearchRunDetails.ts
+++ b/frontend/src/features/research/hooks/useResearchRunDetails.ts
@@ -27,15 +27,12 @@ interface UseResearchRunDetailsReturn {
   loading: boolean;
   error: string | null;
   conversationId: number | null;
-  isConnected: boolean;
-  connectionError: string | null;
   hwEstimatedCostCents: number | null;
   hwActualCostCents: number | null;
   hwCostPerHourCents: number | null;
   stopPending: boolean;
   stopError: string | null;
   handleStopRun: () =&gt; Promise&lt;void&gt;;
-  reconnect: () =&gt; void;
 }
 
 /**
@@ -148,7 +145,29 @@ export function useResearchRunDetails({
         return;
       }
       const eventType = (event as { event_type?: string }).event_type;
-
+      if (eventType === "status_changed") {
+        const metadata =
+          (event as { metadata?: Record&lt;string, unknown&gt; }).metadata ??
+          ({} as Record&lt;string, unknown&gt;);
+        const toStatus = metadata.to_status;
+        const errorMessage = metadata.error_message;
+        if (typeof toStatus === "string") {
+          setDetails(prev =&gt;
+            prev
+              ? {
+                  ...prev,
+                  run: {
+                    ...prev.run,
+                    status: toStatus,
+                    error_message:
+                      typeof errorMessage === "string" ? errorMessage : prev.run.error_message,
+                  },
+                }
+              : prev
+          );
+        }
+        return;
+      }
       if (eventType === "tree_viz_stored") {
         if (!conversationId) {
           return;
@@ -266,7 +285,7 @@ export function useResearchRunDetails({
   }, []);
 
   // Use SSE for real-time updates
-  const { isConnected, connectionError, reconnect } = useResearchRunSSE({
+  useResearchRunSSE({
     runId,
     conversationId,
     enabled:
@@ -308,13 +327,25 @@ export function useResearchRunDetails({
     if (!conversationId || stopPending) {
       return;
     }
+    const refreshDetails = async () =&gt; {
+      try {
+        const refreshed = await apiFetch&lt;ResearchRunDetails&gt;(
+          &#96;/conversations/${conversationId}/idea/research-run/${runId}&#96;
+        );
+        setDetails(refreshed);
+      } catch (refreshErr) {
+        // eslint-disable-next-line no-console
+        console.warn("Failed to refresh run details after stop:", refreshErr);
+      }
+    };
     try {
       setStopError(null);
       setStopPending(true);
       await apiFetch(&#96;/conversations/${conversationId}/idea/research-run/${runId}/stop&#96;, {
         method: "POST",
       });
-      // SSE will automatically receive the status update
+      // Best-effort refresh so the UI updates immediately even if SSE is delayed/lost.
+      await refreshDetails();
     } catch (err) {
       setStopError(err instanceof Error ? err.message : "Failed to stop research run");
     } finally {
@@ -327,14 +358,11 @@ export function useResearchRunDetails({
     loading,
     error,
     conversationId,
-    isConnected,
-    connectionError,
     hwEstimatedCostCents,
     hwActualCostCents,
     hwCostPerHourCents,
     stopPending,
     stopError,
     handleStopRun,
-    reconnect,
   };
 }

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- server/app/api/research_pipeline_runs.py</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- server/app/api/research_pipeline_runs.py
```

```
diff --git a/server/app/api/research_pipeline_runs.py b/server/app/api/research_pipeline_runs.py
index 7bdbc35..d29c990 100644
--- a/server/app/api/research_pipeline_runs.py
+++ b/server/app/api/research_pipeline_runs.py
@@ -29,6 +29,8 @@ from app.models import (
     ResearchRunSubstageSummary,
     TreeVizItem,
 )
+from app.models.sse import ResearchRunCompleteData
+from app.models.sse import ResearchRunCompleteEvent as SSECompleteEvent
 from app.models.sse import ResearchRunRunEvent as SSERunEvent
 from app.services import get_database
 from app.services.billing_guard import enforce_minimum_credits
@@ -455,11 +457,6 @@ def stop_research_run(conversation_id: int, run_id: str) -&gt; ResearchRunStopRespo
     run = db.get_run_for_conversation(run_id=run_id, conversation_id=conversation_id)
     if run is None:
         raise HTTPException(status_code=404, detail="Research run not found")
-    if run.status not in ("pending", "running"):
-        raise HTTPException(
-            status_code=409,
-            detail=f"Research run is already {run.status}; cannot stop.",
-        )
 
     pod_id = run.pod_id
     if pod_id:
@@ -467,10 +464,18 @@ def stop_research_run(conversation_id: int, run_id: str) -&gt; ResearchRunStopRespo
         try:
             terminate_pod(pod_id=pod_id)
         except RunPodError as exc:
-            logger.exception("Failed to terminate pod %s for run %s", pod_id, run_id)
-            raise HTTPException(
-                status_code=502, detail="Failed to terminate the research run pod."
-            ) from exc
+            # If the run is already terminal, treat stop as idempotent (pod may already be gone).
+            if run.status not in ("pending", "running"):
+                logger.info(
+                    "Pod termination for run %s returned RunPodError but run already %s; continuing.",
+                    run_id,
+                    run.status,
+                )
+            else:
+                logger.exception("Failed to terminate pod %s for run %s", pod_id, run_id)
+                raise HTTPException(
+                    status_code=502, detail="Failed to terminate the research run pod."
+                ) from exc
         finally:
             _record_pod_billing_event(
                 db,
@@ -481,13 +486,62 @@ def stop_research_run(conversation_id: int, run_id: str) -&gt; ResearchRunStopRespo
     else:
         logger.info("Run %s has no pod_id; marking as stopped without pod termination.", run_id)
 
+    now = datetime.now(timezone.utc)
+
+    # Idempotent stop: if already terminal, do not error—just return and (best-effort) push SSE so UI updates.
+    if run.status not in ("pending", "running"):
+        message = run.error_message or f"Research run is already {run.status}."
+        run_event = ResearchRunEvent(
+            id=int(now.timestamp() * 1000),
+            run_id=run_id,
+            event_type="status_changed",
+            metadata={
+                "from_status": run.status,
+                "to_status": run.status,
+                "reason": "user_stop_idempotent",
+                "error_message": message,
+            },
+            occurred_at=now.isoformat(),
+        )
+        publish_stream_event(
+            run_id,
+            SSERunEvent(
+                type="run_event",
+                data=run_event,
+            ),
+        )
+        publish_stream_event(
+            run_id,
+            SSECompleteEvent(
+                type="complete",
+                data=ResearchRunCompleteData(
+                    status=run.status,  # type: ignore[arg-type]
+                    success=run.status == "completed",
+                    message=message,
+                ),
+            ),
+        )
+        return ResearchRunStopResponse(
+            run_id=run_id,
+            status="stopped",
+            message=message,
+        )
+
     stop_message = "Research run was stopped by the user."
-    db.update_research_pipeline_run(
+    db.update_research_pipeline_run(run_id=run_id, status="failed", error_message=stop_message)
+    db.insert_research_pipeline_run_event(
         run_id=run_id,
-        status="failed",
-        error_message=stop_message,
+        event_type="status_changed",
+        metadata={
+            "from_status": run.status,
+            "to_status": "failed",
+            "reason": "user_stop",
+            "error_message": stop_message,
+        },
+        occurred_at=now,
     )
-    db.insert_research_pipeline_run_event(
+    run_event = ResearchRunEvent(
+        id=int(now.timestamp() * 1000),
         run_id=run_id,
         event_type="status_changed",
         metadata={
@@ -496,7 +550,25 @@ def stop_research_run(conversation_id: int, run_id: str) -&gt; ResearchRunStopRespo
             "reason": "user_stop",
             "error_message": stop_message,
         },
-        occurred_at=datetime.now(timezone.utc),
+        occurred_at=now.isoformat(),
+    )
+    publish_stream_event(
+        run_id,
+        SSERunEvent(
+            type="run_event",
+            data=run_event,
+        ),
+    )
+    publish_stream_event(
+        run_id,
+        SSECompleteEvent(
+            type="complete",
+            data=ResearchRunCompleteData(
+                status="failed",
+                success=False,
+                message=stop_message,
+            ),
+        ),
     )
 
     return ResearchRunStopResponse(

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/types/research.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/types/research.ts
```

```
diff --git a/frontend/src/types/research.ts b/frontend/src/types/research.ts
index 5b0c424..c262a9f 100644
--- a/frontend/src/types/research.ts
+++ b/frontend/src/types/research.ts
@@ -306,6 +306,51 @@ export interface TreeVizItem {
   updated_at: string;
 }
 
+export interface StageZone {
+  min: number;
+  max: number;
+}
+
+export interface StageZoneMetadata {
+  stageIndex: number;
+  stageId: string;
+  zone: StageZone;
+}
+
+export interface MergedTreeVizPayload {
+  layout: Array&lt;[number, number]&gt;;
+  edges: Array&lt;[number, number]&gt;;
+  stageIds: string[];
+  originalNodeIds: number[];
+  zoneMetadata?: StageZoneMetadata[];
+  code?: string[];
+  plan?: string[];
+  analysis?: string[];
+  metrics?: Array&lt;unknown&gt;;
+  exc_type?: Array&lt;string | null&gt;;
+  exc_info?: Array&lt;{ args?: unknown[] } | null&gt;;
+  exc_stack?: Array&lt;unknown&gt;;
+  plot_plan?: Array&lt;string | null&gt;;
+  plot_code?: Array&lt;string | null&gt;;
+  plot_analyses?: Array&lt;unknown&gt;;
+  plots?: Array&lt;string | string[] | null&gt;;
+  plot_paths?: Array&lt;string | string[] | null&gt;;
+  vlm_feedback_summary?: Array&lt;string | string[] | null&gt;;
+  datasets_successfully_tested?: Array&lt;string[] | null&gt;;
+  exec_time?: Array&lt;number | string | null&gt;;
+  exec_time_feedback?: Array&lt;string | null&gt;;
+  is_best_node?: Array&lt;boolean&gt;;
+  is_seed_node?: Array&lt;boolean&gt;;
+  is_seed_agg_node?: Array&lt;boolean&gt;;
+  ablation_name?: Array&lt;string | null&gt;;
+  hyperparam_name?: Array&lt;string | null&gt;;
+}
+
+export interface MergedTreeViz extends Omit&lt;TreeVizItem, "stage_id" | "viz"&gt; {
+  stage_id: "Full_Tree";
+  viz: MergedTreeVizPayload;
+}
+
 // ==========================================
 // LLM Review Types (for auto-evaluation)
 // ==========================================

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me look at more key components and some of the backend changes to fully understand the PR and provide good feedback.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/NodeTypesLegend.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/NodeTypesLegend.tsx
```

```
diff --git a/frontend/src/features/research/components/run-detail/NodeTypesLegend.tsx b/frontend/src/features/research/components/run-detail/NodeTypesLegend.tsx
new file mode 100644
index 0000000..882b10e
--- /dev/null
+++ b/frontend/src/features/research/components/run-detail/NodeTypesLegend.tsx
@@ -0,0 +1,118 @@
+"use client";
+
+import { useState } from "react";
+import { useIsClient } from "@/shared/hooks/use-is-client";
+import {
+  getStageRelevantNodeTypes,
+  NODE_TYPE_COLORS,
+  BORDER_STYLES,
+  NODE_TYPE_DESCRIPTIONS,
+  BorderStyle,
+} from "@/shared/lib/tree-colors";
+import { Modal } from "@/shared/components/Modal";
+
+interface Props {
+  stageId?: string;
+}
+
+const CIRCLE_RADIUS = 8;
+
+export function NodeTypesLegend({ stageId }: Props) {
+  const isClient = useIsClient();
+  const [open, setOpen] = useState(false);
+
+  if (!isClient) return null;
+
+  const relevantNodeTypes = getStageRelevantNodeTypes(stageId);
+  const normalBorder = BORDER_STYLES[BorderStyle.Normal];
+  const bestBorder = BORDER_STYLES[BorderStyle.Best];
+  const failedBorder = BORDER_STYLES[BorderStyle.Failed];
+  const selectedBorder = BORDER_STYLES[BorderStyle.Selected];
+
+  return (
+    &lt;&gt;
+      &lt;button
+        type="button"
+        onClick={() =&gt; setOpen(true)}
+        title="Show node type legend"
+        className="inline-flex h-6 px-2 items-center justify-center rounded bg-slate-700 text-xs font-semibold text-slate-300 hover:bg-slate-600 transition-colors"
+      &gt;
+        Legend
+      &lt;/button&gt;
+      &lt;Modal isOpen={open} onClose={() =&gt; setOpen(false)} title="Node Types" maxWidth="max-w-md"&gt;
+        &lt;div className="space-y-6"&gt;
+          {/* Node Types */}
+          &lt;div className="space-y-3 max-h-96 overflow-y-auto"&gt;
+            {relevantNodeTypes.map(nodeType =&gt; {
+              const config = NODE_TYPE_COLORS[nodeType];
+              return (
+                &lt;div key={nodeType} className="flex gap-3 items-start"&gt;
+                  &lt;svg width="24" height="24" viewBox="0 0 24 24" className="flex-shrink-0 mt-0.5"&gt;
+                    &lt;circle
+                      cx="12"
+                      cy="12"
+                      r={CIRCLE_RADIUS}
+                      fill={config.color}
+                      stroke={normalBorder.stroke}
+                      strokeWidth="2.2"
+                    /&gt;
+                  &lt;/svg&gt;
+                  &lt;div className="flex-1"&gt;
+                    &lt;div className="font-semibold text-slate-100 text-sm"&gt;{config.label}&lt;/div&gt;
+                    &lt;div className="text-xs text-slate-400"&gt;{NODE_TYPE_DESCRIPTIONS[nodeType]}&lt;/div&gt;
+                  &lt;/div&gt;
+                &lt;/div&gt;
+              );
+            })}
+          &lt;/div&gt;
+
+          {/* Node Status */}
+          &lt;div className="border-t border-slate-700 pt-4"&gt;
+            &lt;div className="text-xs font-semibold text-slate-300 mb-3"&gt;Node Status&lt;/div&gt;
+            &lt;div className="space-y-2"&gt;
+              &lt;div className="flex gap-3 items-center"&gt;
+                &lt;svg width="24" height="24" viewBox="0 0 24 24" className="flex-shrink-0"&gt;
+                  &lt;circle
+                    cx="12"
+                    cy="12"
+                    r={CIRCLE_RADIUS}
+                    fill="#3B82F6"
+                    stroke={bestBorder.stroke}
+                    strokeWidth="2.2"
+                  /&gt;
+                &lt;/svg&gt;
+                &lt;span className="text-xs text-slate-300"&gt;Best node&lt;/span&gt;
+              &lt;/div&gt;
+              &lt;div className="flex gap-3 items-center"&gt;
+                &lt;svg width="24" height="24" viewBox="0 0 24 24" className="flex-shrink-0"&gt;
+                  &lt;circle
+                    cx="12"
+                    cy="12"
+                    r={CIRCLE_RADIUS}
+                    fill="#3B82F6"
+                    stroke={failedBorder.stroke}
+                    strokeWidth="2.2"
+                  /&gt;
+                &lt;/svg&gt;
+                &lt;span className="text-xs text-slate-300"&gt;Abandoned node&lt;/span&gt;
+              &lt;/div&gt;
+              &lt;div className="flex gap-3 items-center"&gt;
+                &lt;svg width="24" height="24" viewBox="0 0 24 24" className="flex-shrink-0"&gt;
+                  &lt;circle
+                    cx="12"
+                    cy="12"
+                    r={CIRCLE_RADIUS}
+                    fill="#3B82F6"
+                    stroke={selectedBorder.stroke}
+                    strokeWidth="2.2"
+                  /&gt;
+                &lt;/svg&gt;
+                &lt;span className="text-xs text-slate-300"&gt;Selected node&lt;/span&gt;
+              &lt;/div&gt;
+            &lt;/div&gt;
+          &lt;/div&gt;
+        &lt;/div&gt;
+      &lt;/Modal&gt;
+    &lt;/&gt;
+  );
+}

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/NodeStrategyGuide.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/NodeStrategyGuide.tsx
```

```
diff --git a/frontend/src/features/research/components/run-detail/NodeStrategyGuide.tsx b/frontend/src/features/research/components/run-detail/NodeStrategyGuide.tsx
new file mode 100644
index 0000000..1a0949b
--- /dev/null
+++ b/frontend/src/features/research/components/run-detail/NodeStrategyGuide.tsx
@@ -0,0 +1,164 @@
+"use client";
+
+import { useState } from "react";
+import { useIsClient } from "@/shared/hooks/use-is-client";
+import { ChevronDown } from "lucide-react";
+import { getStageStrategy } from "@/shared/lib/node-strategy-data";
+import { Modal } from "@/shared/components/Modal";
+
+interface Props {
+  stageId?: string;
+}
+
+export function NodeStrategyGuide({ stageId }: Props) {
+  const isClient = useIsClient();
+  const [open, setOpen] = useState(false);
+  const [expandedPhases, setExpandedPhases] = useState&lt;Set&lt;string&gt;&gt;(new Set());
+
+  if (!isClient) return null;
+
+  // Don't show strategy guide for Full Tree view (no specific stage strategy)
+  if (!stageId) return null;
+
+  const strategy = getStageStrategy(stageId);
+  if (!strategy) return null;
+
+  const togglePhase = (phaseName: string) =&gt; {
+    const newExpanded = new Set(expandedPhases);
+    if (newExpanded.has(phaseName)) {
+      newExpanded.delete(phaseName);
+    } else {
+      newExpanded.add(phaseName);
+    }
+    setExpandedPhases(newExpanded);
+  };
+
+  return (
+    &lt;&gt;
+      &lt;button
+        type="button"
+        onClick={() =&gt; setOpen(true)}
+        title="Show node selection strategy"
+        className="inline-flex h-6 px-2 items-center justify-center rounded bg-slate-700 text-xs font-semibold text-slate-300 hover:bg-slate-600 transition-colors"
+      &gt;
+        Node Strategy
+      &lt;/button&gt;
+      &lt;Modal
+        isOpen={open}
+        onClose={() =&gt; setOpen(false)}
+        title={strategy.title}
+        maxWidth="max-w-2xl"
+        maxHeight="max-h-96"
+      &gt;
+        &lt;div className="space-y-4"&gt;
+          {/* Stage Goal */}
+          &lt;p className="text-sm text-slate-400"&gt;{strategy.goal}&lt;/p&gt;
+
+          {/* Description */}
+          &lt;p className="text-xs text-slate-300 leading-relaxed"&gt;{strategy.description}&lt;/p&gt;
+
+          {/* Overview */}
+          &lt;div className="p-3 bg-slate-700/50 rounded border border-slate-600"&gt;
+            &lt;h3 className="text-xs font-semibold text-slate-200 mb-2"&gt;
+              Decision Strategy Overview
+            &lt;/h3&gt;
+            &lt;p className="text-xs text-slate-300 leading-relaxed"&gt;
+              {strategy.nodeSelectionStrategy.overview}
+            &lt;/p&gt;
+          &lt;/div&gt;
+
+          {/* Phases */}
+          {strategy.nodeSelectionStrategy.phases.length &gt; 0 &amp;&amp; (
+            &lt;div&gt;
+              &lt;h3 className="text-xs font-semibold text-slate-300 mb-3"&gt;Selection Phases&lt;/h3&gt;
+              &lt;div className="space-y-2"&gt;
+                {strategy.nodeSelectionStrategy.phases.map((phase, idx) =&gt; {
+                  const isExpanded = expandedPhases.has(phase.name);
+                  return (
+                    &lt;div key={idx} className="border border-slate-600 rounded bg-slate-700/30"&gt;
+                      &lt;button
+                        type="button"
+                        onClick={() =&gt; togglePhase(phase.name)}
+                        className="w-full flex items-center justify-between p-3 hover:bg-slate-700/50 transition-colors"
+                      &gt;
+                        &lt;div className="text-left"&gt;
+                          &lt;div className="text-xs font-semibold text-slate-200"&gt;{phase.name}&lt;/div&gt;
+                          &lt;div className="text-xs text-slate-400 mt-1"&gt;
+                            Trigger: {phase.trigger}
+                          &lt;/div&gt;
+                        &lt;/div&gt;
+                        &lt;ChevronDown
+                          className={&#96;w-4 h-4 text-slate-400 flex-shrink-0 ml-2 transition-transform ${
+                            isExpanded ? "rotate-180" : ""
+                          }&#96;}
+                        /&gt;
+                      &lt;/button&gt;
+
+                      {isExpanded &amp;&amp; (
+                        &lt;div className="px-3 pt-3 pb-3 border-t border-slate-600 space-y-3"&gt;
+                          {/* Description */}
+                          &lt;div&gt;
+                            &lt;p className="text-xs text-slate-300 leading-relaxed"&gt;
+                              {phase.description}
+                            &lt;/p&gt;
+                          &lt;/div&gt;
+
+                          {/* Action */}
+                          &lt;div&gt;
+                            &lt;div className="text-xs font-semibold text-slate-300 mb-1"&gt;Action:&lt;/div&gt;
+                            &lt;div className="text-xs text-slate-400 ml-2"&gt;{phase.action}&lt;/div&gt;
+                          &lt;/div&gt;
+
+                          {/* Config Values */}
+                          {phase.configValues.length &gt; 0 &amp;&amp; (
+                            &lt;div&gt;
+                              &lt;div className="text-xs font-semibold text-slate-300 mb-1"&gt;
+                                Config Values:
+                              &lt;/div&gt;
+                              &lt;div className="space-y-1"&gt;
+                                {phase.configValues.map((value, cidx) =&gt; (
+                                  &lt;div
+                                    key={cidx}
+                                    className="text-xs text-slate-300 ml-2 font-mono bg-slate-900/50 px-2 py-1 rounded border border-slate-600"
+                                  &gt;
+                                    {value}
+                                  &lt;/div&gt;
+                                ))}
+                              &lt;/div&gt;
+                            &lt;/div&gt;
+                          )}
+
+                          {/* Selection Criteria */}
+                          &lt;div&gt;
+                            &lt;div className="text-xs font-semibold text-slate-300 mb-1"&gt;
+                              Selection Criteria:
+                            &lt;/div&gt;
+                            &lt;ul className="space-y-1 ml-2"&gt;
+                              {phase.selectionCriteria.map((criterion, cidx) =&gt; (
+                                &lt;li key={cidx} className="text-xs text-slate-400"&gt;
+                                  • {criterion}
+                                &lt;/li&gt;
+                              ))}
+                            &lt;/ul&gt;
+                          &lt;/div&gt;
+                        &lt;/div&gt;
+                      )}
+                    &lt;/div&gt;
+                  );
+                })}
+              &lt;/div&gt;
+            &lt;/div&gt;
+          )}
+
+          {/* Example Flow */}
+          &lt;div className="p-3 bg-slate-700/50 rounded border border-slate-600"&gt;
+            &lt;h3 className="text-xs font-semibold text-slate-200 mb-2"&gt;Example Decision Flow&lt;/h3&gt;
+            &lt;pre className="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap break-words"&gt;
+              {strategy.exampleFlow}
+            &lt;/pre&gt;
+          &lt;/div&gt;
+        &lt;/div&gt;
+      &lt;/Modal&gt;
+    &lt;/&gt;
+  );
+}

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/node-strategy-data.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/node-strategy-data.ts
```

```
diff --git a/frontend/src/shared/lib/node-strategy-data.ts b/frontend/src/shared/lib/node-strategy-data.ts
new file mode 100644
index 0000000..8b45e88
--- /dev/null
+++ b/frontend/src/shared/lib/node-strategy-data.ts
@@ -0,0 +1,211 @@
+/**
+ * Node Strategy Guide Data
+ *
+ * This file contains descriptions of how the BFTS algorithm decides which node to explore
+ * next in each stage, along with the configuration values that control the behavior.
+ *
+ * IMPORTANT: Keep config values in sync with research_pipeline/bfts_config_template.yaml (lines 71-75)
+ * If you update the YAML, update these values here as well to ensure the UI stays current.
+ */
+
+export const SEARCH_CONFIG = {
+  num_drafts: 3,
+  debug_prob: 0.7,
+  max_debug_depth: 5,
+} as const;
+
+export interface Phase {
+  name: string;
+  description: string;
+  trigger: string;
+  configValues: string[];
+  action: string;
+  selectionCriteria: string[];
+}
+
+export interface StageStrategy {
+  title: string;
+  goal: string;
+  description: string;
+  nodeSelectionStrategy: {
+    overview: string;
+    phases: Phase[];
+  };
+  exampleFlow: string;
+}
+
+export type StageId = "Stage_1" | "Stage_2" | "Stage_3" | "Stage_4";
+
+export const STAGE_STRATEGIES: Record&lt;StageId, StageStrategy&gt; = {
+  Stage_1: {
+    title: "Stage 1: Baseline Implementation",
+    goal: "Develop functional code which can produce a runnable result",
+    description:
+      "The AE Scientist generates initial implementations and iteratively debugs failures to achieve a working baseline. The strategy balances exploration (trying multiple approaches) with exploitation (improving the best solutions found).",
+    nodeSelectionStrategy: {
+      overview:
+        "Stage 1 uses a combination of exploration (drafting new implementations) and exploitation (debugging failures or improving working code). The decision-making process follows three phases that work together to efficiently search the implementation space.",
+      phases: [
+        {
+          name: "Drafting Phase",
+          description:
+            "Initial new implementations are generated from scratch. This exploration phase ensures the search space is adequately explored before committing to optimization of any single approach.",
+          trigger: &#96;When draft_nodes count &lt; ${SEARCH_CONFIG.num_drafts}&#96;,
+          configValues: [&#96;num_drafts: ${SEARCH_CONFIG.num_drafts}&#96;],
+          action: "Generate a new root node (exploration)",
+          selectionCriteria: [
+            "Always create new drafts until reaching target count",
+            "Ensures sufficient starting points before optimizing",
+          ],
+        },
+        {
+          name: "Debugging Phase",
+          description:
+            "Failed implementations (buggy nodes) are selected for debugging attempts. This is controlled by a probability mechanism that prevents the algorithm from getting stuck optimizing one path while ignoring potentially better alternatives. The depth limit prevents infinite debugging loops.",
+          trigger: &#96;Decided randomly (${Math.round(SEARCH_CONFIG.debug_prob * 100)}% of the time)&#96;,
+          configValues: [
+            &#96;debug_prob: ${SEARCH_CONFIG.debug_prob} (${Math.round(SEARCH_CONFIG.debug_prob * 100)}% chance of debugging)&#96;,
+            &#96;max_debug_depth: ${SEARCH_CONFIG.max_debug_depth} (max iterations per node)&#96;,
+          ],
+          action: "Select a buggy leaf node and attempt fixes",
+          selectionCriteria: [
+            "Must be a leaf node (not yet processed/has no children)",
+            &#96;debug_depth must be ≤ ${SEARCH_CONFIG.max_debug_depth} to prevent infinite loops&#96;,
+            "Avoid processing the same tree twice in parallel to maintain diversity",
+            "Choose from available buggy nodes randomly",
+          ],
+        },
+        {
+          name: "Improvement Phase",
+          description:
+            "Working implementations are refined and optimized. Uses best-first search to prioritize the most promising implementations while maintaining diversity through parallel processing.",
+          trigger: &#96;Decided randomly (${Math.round((1 - SEARCH_CONFIG.debug_prob) * 100)}% of the time) or when there are no debugging opportunities&#96;,
+          configValues: [],
+          action: "Select best performing node and create improvements",
+          selectionCriteria: [
+            "Choose best node by metric (highest accuracy/lowest loss)",
+            "Prioritize unprocessed trees to maintain diversity",
+            "Fall back to next-best nodes if best tree already in processing queue",
+            "Uses LLM evaluation when multiple candidates have similar metrics",
+          ],
+        },
+      ],
+    },
+    exampleFlow: &#96;1. Generate ${SEARCH_CONFIG.num_drafts} initial draft implementations (exploration)
+2. For each subsequent iteration, either:
+   a. (${Math.round(SEARCH_CONFIG.debug_prob * 100)}% chance) Debug a failed implementation (up to ${SEARCH_CONFIG.max_debug_depth} attempts)
+   b. (${Math.round((1 - SEARCH_CONFIG.debug_prob) * 100)}% chance) Improve the best working implementation
+3. Continue until stage completion criteria are met (working implementation + sufficient exploration)&#96;,
+  },
+
+  Stage_2: {
+    title: "Stage 2: Baseline Tuning",
+    goal: "Improve baseline through hyperparameter optimization",
+    description:
+      "The AE Scientist systematically explores hyperparameter variations of the best Stage 1 implementation. Unlike Stage 1, this stage does not explore new code structures—it focuses purely on optimizing parameters of the proven baseline.",
+    nodeSelectionStrategy: {
+      overview:
+        "Stage 2 bypasses the drafting/debugging logic from Stage 1 and instead focuses exclusively on hyperparameter variations. The search is anchored to the best implementation from Stage 1. Each iteration generates a different hyperparameter tuning proposal.",
+      phases: [
+        {
+          name: "Hyperparameter Tuning",
+          description:
+            "Systematic exploration of hyperparameter combinations. Each iteration proposes new parameter values based on analysis of previous results, measured improvements, and domain knowledge about the algorithm.",
+          trigger: "Always - Stage 2 is dedicated to this task",
+          configValues: [],
+          action: "Apply hyperparameter tuning variation to best Stage 1 node",
+          selectionCriteria: [
+            "Always use best_stage1_node as the parent/baseline",
+            "Generate new hyperparameter ideas each iteration",
+            "Evaluate impact of each parameter change across multiple datasets",
+            "Track which parameter combinations show promise",
+          ],
+        },
+      ],
+    },
+    exampleFlow: &#96;1. Select best implementation from Stage 1 (the baseline)
+2. For each iteration:
+   - Propose a hyperparameter tuning variation (e.g., different learning rate, batch size, regularization)
+   - Apply it to the Stage 1 code
+   - Evaluate performance on multiple datasets
+   - Keep track of improvements
+3. Continue until diminishing returns or iteration limit reached&#96;,
+  },
+
+  Stage_3: {
+    title: "Stage 3: Creative Exploration",
+    goal: "Explore higher-leverage variants with supporting analysis",
+    description:
+      "The AE Scientist generates creative variants and explores new research directions with empirical validation. Unlike Stage 1's focus on basic functionality, Stage 3 proposes more ambitious changes (new architectures, novel techniques) and backs them up with analysis (plots, ablations, comparisons).",
+    nodeSelectionStrategy: {
+      overview:
+        "Stage 3 returns to exploration/exploitation dynamics similar to Stage 1, but with a focus on higher-leverage conceptual variations rather than basic debugging. The selection strategy emphasizes both performance metrics and analysis quality.",
+      phases: [
+        {
+          name: "Exploration Phase",
+          description:
+            "New creative variants are explored alongside systematic refinement of working approaches. This phase balances trying new ideas with improving promising directions.",
+          trigger: "Standard best-first search with creative variation generation",
+          configValues: [
+            &#96;num_drafts: ${SEARCH_CONFIG.num_drafts}&#96;,
+            &#96;debug_prob: ${SEARCH_CONFIG.debug_prob}&#96;,
+          ],
+          action: "Explore creative variants with supporting analysis and plots",
+          selectionCriteria: [
+            "Use best-first tree search over creative variants",
+            "Prioritize nodes with supporting plots/analyses",
+            "Consider both metrics and VLM (visual language model) feedback on plots",
+            "Focus on variants that represent conceptual improvements, not just parameter tweaks",
+          ],
+        },
+      ],
+    },
+    exampleFlow: &#96;1. Generate initial creative variants (exploration - architecture changes, novel techniques)
+2. For each iteration, either:
+   a. Debug failed variants (less common in Stage 3)
+   b. Improve successful variants with deeper analysis (generate plots, comparisons)
+3. Selection based on both metrics and analysis quality (not just accuracy numbers)
+4. Continue until strong research ideas are exhausted&#96;,
+  },
+
+  Stage_4: {
+    title: "Stage 4: Ablation Studies",
+    goal: "Run controlled ablations to understand component contributions",
+    description:
+      "The AE Scientist performs controlled ablation studies on the best Stage 3 implementation to isolate the importance of individual components. This provides insight into which parts of the solution are critical versus optional.",
+    nodeSelectionStrategy: {
+      overview:
+        "Stage 4 anchors all work to the best Stage 3 node, systematically removing or modifying specific components to measure their contribution to overall performance. This is a systematic analysis phase, not an exploration phase.",
+      phases: [
+        {
+          name: "Component Ablation",
+          description:
+            "Each iteration systematically removes or modifies a specific component to measure its performance impact. This helps identify which components are critical versus redundant.",
+          trigger: "Always - Stage 4 is dedicated to ablation studies",
+          configValues: [],
+          action: "Apply ablation variation to best Stage 3 node",
+          selectionCriteria: [
+            "Always use best_stage3_node as the baseline",
+            "Generate ablation variations for different components",
+            "Measure performance delta for each ablation",
+            "Track which components are most critical to performance",
+            "Test statistical significance of results",
+          ],
+        },
+      ],
+    },
+    exampleFlow: &#96;1. Select best implementation from Stage 3
+2. For each component in the implementation:
+   - Create variant with that component removed/disabled
+   - Run with and without the component
+   - Measure performance difference
+   - Document importance of the component
+3. Provide analysis of which components drive improvements
+4. Identify core components vs. nice-to-have optimizations&#96;,
+  },
+};
+
+export function getStageStrategy(stageId: string): StageStrategy | null {
+  const normalizedId = stageId as StageId;
+  return STAGE_STRATEGIES[normalizedId] || null;
+}

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me look at a few more key files to get a complete picture of the PR changes, particularly the backend and some other frontend changes.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/components/Modal.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/components/Modal.tsx
```

```
diff --git a/frontend/src/shared/components/Modal.tsx b/frontend/src/shared/components/Modal.tsx
new file mode 100644
index 0000000..7d81a7f
--- /dev/null
+++ b/frontend/src/shared/components/Modal.tsx
@@ -0,0 +1,61 @@
+"use client";
+
+import { useEffect, ReactNode } from "react";
+import { createPortal } from "react-dom";
+import { X } from "lucide-react";
+
+interface ModalProps {
+  isOpen: boolean;
+  onClose: () =&gt; void;
+  title: string;
+  children: ReactNode;
+  maxWidth?: string;
+  maxHeight?: string;
+}
+
+/**
+ * Reusable modal dialog component with escape key handling
+ */
+export function Modal({
+  isOpen,
+  onClose,
+  title,
+  children,
+  maxWidth = "max-w-2xl",
+  maxHeight = "max-h-96",
+}: ModalProps) {
+  useEffect(() =&gt; {
+    if (!isOpen) return;
+
+    const handleEscape = (e: KeyboardEvent) =&gt; {
+      if (e.key === "Escape") {
+        onClose();
+      }
+    };
+
+    document.addEventListener("keydown", handleEscape);
+    return () =&gt; document.removeEventListener("keydown", handleEscape);
+  }, [isOpen, onClose]);
+
+  if (!isOpen) return null;
+
+  return createPortal(
+    &lt;div className="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/50"&gt;
+      &lt;div
+        className={&#96;relative rounded-lg border border-slate-700 bg-slate-800 p-6 shadow-xl ${maxWidth} w-full ${maxHeight} overflow-y-auto&#96;}
+      &gt;
+        &lt;button
+          type="button"
+          onClick={onClose}
+          className="absolute top-4 right-4 p-1 hover:bg-slate-700 rounded transition-colors flex-shrink-0"
+          title="Close modal"
+        &gt;
+          &lt;X className="w-4 h-4 text-slate-400" /&gt;
+        &lt;/button&gt;
+        &lt;h2 className="text-lg font-semibold text-slate-100 mb-4 pr-6"&gt;{title}&lt;/h2&gt;
+        {children}
+      &lt;/div&gt;
+    &lt;/div&gt;,
+    document.body
+  );
+}

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/research-run-stats.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/components/run-detail/research-run-stats.tsx
```

```
diff --git a/frontend/src/features/research/components/run-detail/research-run-stats.tsx b/frontend/src/features/research/components/run-detail/research-run-stats.tsx
index f0276c5..7bfdef2 100644
--- a/frontend/src/features/research/components/run-detail/research-run-stats.tsx
+++ b/frontend/src/features/research/components/run-detail/research-run-stats.tsx
@@ -1,91 +1,30 @@
 "use client";
 
 import { Activity, Cpu, FlaskConical, Package } from "lucide-react";
-import type { StageProgress } from "@/types/research";
 import { StatCard } from "./stat-card";
+import { getCurrentStageLabel } from "../../utils/research-utils";
 
 interface ResearchRunStatsProps {
-  stageProgress: StageProgress[];
+  status: string;
+  currentStage: string | null;
+  progress: number | null;
   gpuType: string | null;
   artifactsCount: number;
 }
 
-/**
- * Extract stage slug from backend stage name format
- * Example: "1_initial_implementation" → "initial_implementation"
- */
-const extractStageSlug = (stageName: string): string =&gt; {
-  const parts = stageName.split("_");
-  const slugParts: string[] = [];
-  for (let i = 1; i &lt; parts.length; i++) {
-    const part = parts[i];
-    if (!part) continue;
-    // Stop when we hit a number (substage number)
-    if (/^\d+$/.test(part)) break;
-    slugParts.push(part);
-  }
-  return slugParts.join("_");
-};
-
-const STAGE_ORDER = [
-  "initial_implementation",
-  "baseline_tuning",
-  "creative_research",
-  "ablation_studies",
-  "paper_generation",
-] as const;
-
-/**
- * Calculate overall progress based on completed stages
- * Each stage = 20% (5 stages total)
- * Returns: (completedStages * 20)%
- */
-function calculateOverallProgress(stageProgress: StageProgress[]): number {
-  if (!stageProgress.length) return 0;
-
-  // Map stage names to their latest progress
-  const stageMap = new Map&lt;string, StageProgress&gt;();
-  for (const sp of stageProgress) {
-    const slug = extractStageSlug(sp.stage);
-    if (slug) {
-      stageMap.set(slug, sp);
-    }
-  }
-
-  // Count completed stages (progress &gt;= 1.0)
-  let completedCount = 0;
-  for (const slug of STAGE_ORDER) {
-    const sp = stageMap.get(slug);
-    if (!sp) break; // Haven't reached this stage yet
-    if (sp.progress &gt;= 1.0) {
-      completedCount++;
-    } else {
-      break; // Current stage not complete, stop counting
-    }
-  }
-
-  return completedCount * 20;
-}
-
-/**
- * Get display name for the current stage
- */
-const getStageDisplayName = (stageProgress: StageProgress[]): string =&gt; {
-  if (!stageProgress.length) return "Pending";
-  const latestProgress = stageProgress[stageProgress.length - 1];
-  return latestProgress?.stage || "Pending";
-};
-
 /**
  * Overview stats grid for research run detail page
  */
 export function ResearchRunStats({
-  stageProgress,
+  status,
+  currentStage,
+  progress,
   gpuType,
   artifactsCount,
 }: ResearchRunStatsProps) {
-  const progressPercent = &#96;${calculateOverallProgress(stageProgress)}%&#96;;
-  const currentStage = getStageDisplayName(stageProgress);
+  const currentStageLabel = getCurrentStageLabel(status, currentStage, progress);
+  const progressLabel =
+    progress === null || progress === undefined ? "-" : &#96;${Math.round(progress * 100)}%&#96;;
 
   return (
     &lt;div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"&gt;
@@ -93,14 +32,14 @@ export function ResearchRunStats({
         icon={FlaskConical}
         iconColorClass="bg-emerald-500/15 text-emerald-400"
         label="Current Stage"
-        value={currentStage}
-        title={currentStage}
+        value={currentStageLabel}
+        title={currentStageLabel}
       /&gt;
       &lt;StatCard
         icon={Activity}
         iconColorClass="bg-sky-500/15 text-sky-400"
         label="Progress"
-        value={progressPercent}
+        value={progressLabel}
       /&gt;
       &lt;StatCard
         icon={Cpu}

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- research_pipeline/ai_scientist/treesearch/parallel_agent.py | head -200</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- research_pipeline/ai_scientist/treesearch/parallel_agent.py | head -200
```

```
diff --git a/research_pipeline/ai_scientist/treesearch/parallel_agent.py b/research_pipeline/ai_scientist/treesearch/parallel_agent.py
index 5b651ef..f2d8b73 100644
--- a/research_pipeline/ai_scientist/treesearch/parallel_agent.py
+++ b/research_pipeline/ai_scientist/treesearch/parallel_agent.py
@@ -90,10 +90,8 @@ class ParallelAgent:
 
         # Create process pool for parallel execution
         self.timeout = self.cfg.exec.timeout
-        mp_context = multiprocessing.get_context("spawn")
-        self.executor: ProcessPoolExecutor = ProcessPoolExecutor(
-            max_workers=self.num_workers, mp_context=mp_context
-        )
+        self._mp_context = multiprocessing.get_context("spawn")
+        self.executor: ProcessPoolExecutor | None = self._create_executor()
         self._is_shutdown = False
         # Define the evaluation metric once at initialization
         self.evaluation_metrics = self._define_global_metrics()
@@ -203,6 +201,7 @@ class ParallelAgent:
         seed_nodes: List[Node] = []
         futures: list = []
         seed_process_ids: list[str | None] = []  # Track process IDs for GPU release
+        executor = self._ensure_executor()
         for seed in range(self.cfg.agent.multi_seed_eval["num_seeds"]):
             gpu_id = None
             process_id = f"seed_{seed}_worker"
@@ -228,7 +227,7 @@ class ParallelAgent:
             memory_summary = ""
             logger.info("Starting multi-seed eval...")
             futures.append(
-                self.executor.submit(
+                executor.submit(
                     process_node,
                     node_data=node_data,
                     task_desc=self.task_desc,
@@ -465,6 +464,7 @@ class ParallelAgent:
         # Submit tasks to process pool
         logger.debug("Submitting tasks to process pool")
 
+        executor = self._ensure_executor()
         futures: list[Future] = []
         for node_data in node_data_list:
             gpu_id = None
@@ -513,7 +513,7 @@ class ParallelAgent:
             )
             seed_eval = False
             futures.append(
-                self.executor.submit(
+                executor.submit(
                     process_node,
                     node_data=node_data,
                     task_desc=self.task_desc,
@@ -587,6 +587,7 @@ class ParallelAgent:
                         level="warn",
                     )
                 )
+                self._handle_worker_timeout(future=future)
             except Exception as e:
                 logger.exception(f"Error processing node: {str(e)}")
 
@@ -613,19 +614,7 @@ class ParallelAgent:
                     for process_id in list(self.gpu_manager.gpu_assignments.keys()):
                         self.gpu_manager.release_gpu(process_id)
 
-                # Shutdown executor first
-                self.executor.shutdown(wait=False, cancel_futures=True)
-
-                # Force terminate all worker processes
-                if self.executor._processes:
-                    # Get copy of processes
-                    processes = list(self.executor._processes.values())
-
-                    # Then terminate processes if they're still alive
-                    for process in processes:
-                        if process.is_alive():
-                            process.terminate()
-                            process.join(timeout=1)
+                self._shutdown_executor()
 
                 logger.info("Executor shutdown complete")
 
@@ -641,3 +630,39 @@ class ParallelAgent:
         exc_tb: TracebackType | None,
     ) -&gt; None:
         self.cleanup()
+
+    def _create_executor(self) -&gt; ProcessPoolExecutor:
+        return ProcessPoolExecutor(
+            max_workers=self.num_workers,
+            mp_context=self._mp_context,
+        )
+
+    def _shutdown_executor(self) -&gt; None:
+        executor = self.executor
+        if executor is None:
+            return
+        try:
+            executor.shutdown(wait=False, cancel_futures=True)
+            processes = []
+            if getattr(executor, "_processes", None):
+                processes = list(executor._processes.values())
+            for process in processes:
+                if process.is_alive():
+                    process.terminate()
+                    process.join(timeout=1)
+        finally:
+            self.executor = None
+
+    def _restart_executor(self) -&gt; None:
+        logger.warning("Restarting process pool executor after worker timeout")
+        self._shutdown_executor()
+        self.executor = self._create_executor()
+
+    def _handle_worker_timeout(self, *, future: Future) -&gt; None:
+        future.cancel()
+        self._restart_executor()
+
+    def _ensure_executor(self) -&gt; ProcessPoolExecutor:
+        if self.executor is None:
+            self.executor = self._create_executor()
+        return self.executor

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me check a few more files for completeness and then compile my review feedback.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/utils/research-utils.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/research/utils/research-utils.tsx
```

```
diff --git a/frontend/src/features/research/utils/research-utils.tsx b/frontend/src/features/research/utils/research-utils.tsx
index 3e08aab..ea6364c 100644
--- a/frontend/src/features/research/utils/research-utils.tsx
+++ b/frontend/src/features/research/utils/research-utils.tsx
@@ -4,6 +4,70 @@
 import type { ReactNode } from "react";
 import { CheckCircle2, Clock, Loader2, AlertCircle } from "lucide-react";
 
+/**
+ * Converts backend stage ids into a human-readable label.
+ *
+ * Backend format: {stage_number}_{stage_slug}[_{substage_number}_{substage_slug}...]
+ * Examples:
+ * - "5_paper_generation" -&gt; "5: Paper Generation"
+ * - "2_baseline_tuning_2_optimization" -&gt; "2: Baseline Tuning"
+ */
+const STAGE_LABEL_BY_NUMBER: Record&lt;string, string&gt; = {
+  "1": "1: Baseline Implementation",
+  "2": "2: Baseline Tuning",
+  "3": "3: Creative Research",
+  "4": "4: Ablation Studies",
+  "5": "5: Paper Generation",
+};
+
+function extractLeadingStageNumber(stage: string): string | null {
+  const match = stage.match(/^(\d+)(?:_|$)/);
+  return match?.[1] ?? null;
+}
+
+export function formatResearchStageName(stage: string | null | undefined): string | null {
+  if (!stage) return null;
+  const raw = stage.trim();
+  if (!raw) return null;
+
+  const stageNumber = extractLeadingStageNumber(raw);
+  if (stageNumber) return STAGE_LABEL_BY_NUMBER[stageNumber] ?? raw;
+
+  // Fallback: if we ever get an unexpected stage name, don't break UI—just show the raw value.
+  return raw;
+}
+
+/**
+ * Determines the current stage label for display in stats
+ * Takes into account status, current stage, and progress to show the most appropriate label
+ * @param status - Research run status
+ * @param currentStage - Current pipeline stage
+ * @param progress - Current progress (0-1)
+ * @returns Display label for current stage
+ */
+export function getCurrentStageLabel(
+  status: string,
+  currentStage: string | null,
+  progress: number | null
+): string {
+  // If explicitly completed or failed, show that status
+  if (status === "completed") return "Completed";
+  if (status === "failed") return "Failed";
+
+  // Check if final stage is complete (stage 5 with 100% progress)
+  const isFinalStageComplete =
+    typeof currentStage === "string" &amp;&amp;
+    currentStage.startsWith("5_") &amp;&amp;
+    progress !== null &amp;&amp;
+    progress !== undefined &amp;&amp;
+    progress &gt;= 1;
+
+  if (isFinalStageComplete) return "Completed";
+
+  // Format the current stage name
+  return (formatResearchStageName(currentStage) ?? currentStage) || "Pending";
+}
+
 /**
  * Stage badge configuration for Open/Closed compliance
  */
@@ -34,7 +98,7 @@ export function getStatusText(status: string, currentStage: string | null): stri
       return "Completed";
     case "running":
       if (currentStage) {
-        return &#96;Running ${currentStage}&#96;;
+        return &#96;Running ${formatResearchStageName(currentStage) ?? currentStage}&#96;;
       }
       return "Running";
     case "failed":
@@ -125,13 +189,33 @@ export function truncateRunId(runId: string, maxLength = 14): string {
 /**
  * Returns a styled stage badge for a research pipeline stage
  * @param stage - Pipeline stage string (baseline, tuning, plotting, ablation)
+ * @param status - Optional run status to check for completed/failed states
  * @param configs - Optional custom stage configurations (Open/Closed compliant)
  * @returns React element with styled badge, or null if no stage
  */
 export function getStageBadge(
   stage: string | null,
+  status?: string | null,
   configs: StageBadgeConfig[] = DEFAULT_STAGE_CONFIGS
 ): ReactNode {
+  // If status is completed, show "Completed" badge
+  if (status === "completed") {
+    return (
+      &lt;span className="inline-flex rounded-lg border px-2.5 py-1 text-xs font-medium bg-emerald-500/15 text-emerald-400 border-emerald-500/30"&gt;
+        Completed
+      &lt;/span&gt;
+    );
+  }
+
+  // If status is failed, show "Failed" badge
+  if (status === "failed") {
+    return (
+      &lt;span className="inline-flex rounded-lg border px-2.5 py-1 text-xs font-medium bg-red-500/15 text-red-400 border-red-500/30"&gt;
+        Failed
+      &lt;/span&gt;
+    );
+  }
+
   if (!stage) return null;
 
   const matchedConfig = configs.find(config =&gt; stage.toLowerCase().includes(config.pattern));
@@ -139,9 +223,11 @@ export function getStageBadge(
   const colorClass =
     matchedConfig?.className ?? "bg-slate-500/15 text-slate-400 border-slate-500/30";
 
+  const label = formatResearchStageName(stage) ?? stage;
+
   return (
     &lt;span className={&#96;inline-flex rounded-lg border px-2.5 py-1 text-xs font-medium ${colorClass}&#96;}&gt;
-      {stage}
+      {label}
     &lt;/span&gt;
   );
 }

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- server/app/services/database/research_pipeline_runs.py</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- server/app/services/database/research_pipeline_runs.py
```

```
diff --git a/server/app/services/database/research_pipeline_runs.py b/server/app/services/database/research_pipeline_runs.py
index 32c8be6..d95539d 100644
--- a/server/app/services/database/research_pipeline_runs.py
+++ b/server/app/services/database/research_pipeline_runs.py
@@ -392,44 +392,38 @@ class ResearchPipelineRunsMixin(ConnectionProvider):
         or None if not found.
         """
         query = """
-            WITH latest_stage_progress AS (
-                SELECT DISTINCT ON (run_id)
-                    run_id,
-                    stage,
-                    progress,
-                    best_metric,
-                    created_at
+            WITH all_progress AS (
+                SELECT run_id, stage, progress, best_metric, created_at
                 FROM rp_run_stage_progress_events
-                ORDER BY run_id, created_at DESC
+                UNION ALL
+                SELECT run_id, '5_paper_generation'::text, progress, NULL::text, created_at
+                FROM rp_paper_generation_events
             ),
-            latest_paper_progress AS (
+            latest_progress AS (
                 SELECT DISTINCT ON (run_id)
                     run_id,
-                    '5_paper_generation' AS stage,
+                    stage,
                     progress,
-                    NULL::text AS best_metric,
+                    best_metric,
                     created_at
-                FROM rp_paper_generation_events
+                FROM all_progress
                 ORDER BY run_id, created_at DESC
             ),
-            latest_progress AS (
+            progress_with_calculations AS (
                 SELECT
-                    COALESCE(pp.run_id, sp.run_id) AS run_id,
-                    COALESCE(pp.stage, sp.stage) AS stage,
-                    sp.best_metric,
-                    -- Calculate overall progress: each stage is 20%% of total (5 stages)
-                    -- For stages 1-4: show fixed percentage based on stage number
-                    -- For stage 5: interpolate from 80%% to 100%% based on paper generation progress
-                    CASE 
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '1_%%' THEN 0.2
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '2_%%' THEN 0.4
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '3_%%' THEN 0.6
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '4_%%' THEN 0.8
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '5_%%' THEN 0.8 + (COALESCE(pp.progress, sp.progress) * 0.2)
-                        ELSE COALESCE(pp.progress, sp.progress)
+                    run_id,
+                    stage,
+                    best_metric,
+                    -- Calculate overall progress as completed-stages-only buckets.
+                    -- If the *current* stage is incomplete, the displayed progress reflects
+                    -- only the number of fully-completed stages (0, 0.2, 0.4, 0.6, 0.8, 1.0).
+                    CASE
+                        WHEN stage ~ '^[1-5]_' THEN
+                            CAST(substring(stage FROM 1 FOR 1) AS numeric) * 0.2 -
+                            CASE WHEN progress &gt;= 1 THEN 0 ELSE 0.2 END
+                        ELSE progress
                     END AS overall_progress
-                FROM latest_stage_progress sp
-                FULL OUTER JOIN latest_paper_progress pp ON sp.run_id = pp.run_id
+                FROM latest_progress
             ),
             artifact_counts AS (
                 SELECT run_id, COUNT(*) as count
@@ -448,16 +442,16 @@ class ResearchPipelineRunsMixin(ConnectionProvider):
                 iv.short_hypothesis AS idea_hypothesis,
                 u.name AS created_by_name,
                 u.id AS created_by_user_id,
-                lp.stage AS current_stage,
-                lp.overall_progress AS progress,
-                lp.best_metric,
+                pc.stage AS current_stage,
+                pc.overall_progress AS progress,
+                pc.best_metric,
                 COALESCE(ac.count, 0) AS artifacts_count,
                 i.conversation_id
             FROM research_pipeline_runs r
             JOIN ideas i ON r.idea_id = i.id
             JOIN idea_versions iv ON r.idea_version_id = iv.id
             JOIN users u ON i.created_by_user_id = u.id
-            LEFT JOIN latest_progress lp ON r.run_id = lp.run_id
+            LEFT JOIN progress_with_calculations pc ON r.run_id = pc.run_id
             LEFT JOIN artifact_counts ac ON r.run_id = ac.run_id
             WHERE r.run_id = %s
         """
@@ -528,44 +522,38 @@ class ResearchPipelineRunsMixin(ConnectionProvider):
             where_sql = "WHERE " + " AND ".join(where_clauses)
 
         query = f"""
-            WITH latest_stage_progress AS (
-                SELECT DISTINCT ON (run_id)
-                    run_id,
-                    stage,
-                    progress,
-                    best_metric,
-                    created_at
+            WITH all_progress AS (
+                SELECT run_id, stage, progress, best_metric, created_at
                 FROM rp_run_stage_progress_events
-                ORDER BY run_id, created_at DESC
+                UNION ALL
+                SELECT run_id, '5_paper_generation'::text, progress, NULL::text, created_at
+                FROM rp_paper_generation_events
             ),
-            latest_paper_progress AS (
+            latest_progress AS (
                 SELECT DISTINCT ON (run_id)
                     run_id,
-                    '5_paper_generation' AS stage,
+                    stage,
                     progress,
-                    NULL::text AS best_metric,
+                    best_metric,
                     created_at
-                FROM rp_paper_generation_events
+                FROM all_progress
                 ORDER BY run_id, created_at DESC
             ),
-            latest_progress AS (
+            progress_with_calculations AS (
                 SELECT
-                    COALESCE(pp.run_id, sp.run_id) AS run_id,
-                    COALESCE(pp.stage, sp.stage) AS stage,
-                    sp.best_metric,
-                    -- Calculate overall progress: each stage is 20%% of total (5 stages)
-                    -- For stages 1-4: show fixed percentage based on stage number
-                    -- For stage 5: interpolate from 80%% to 100%% based on paper generation progress
-                    CASE 
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '1_%%' THEN 0.2
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '2_%%' THEN 0.4
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '3_%%' THEN 0.6
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '4_%%' THEN 0.8
-                        WHEN COALESCE(pp.stage, sp.stage) LIKE '5_%%' THEN 0.8 + (COALESCE(pp.progress, sp.progress) * 0.2)
-                        ELSE COALESCE(pp.progress, sp.progress)
+                    run_id,
+                    stage,
+                    best_metric,
+                    -- Calculate overall progress as completed-stages-only buckets.
+                    -- If the *current* stage is incomplete, the displayed progress reflects
+                    -- only the number of fully-completed stages (0, 0.2, 0.4, 0.6, 0.8, 1.0).
+                    CASE
+                        WHEN stage ~ '^[1-5]_' THEN
+                            CAST(substring(stage FROM 1 FOR 1) AS numeric) * 0.2 -
+                            CASE WHEN progress &gt;= 1 THEN 0 ELSE 0.2 END
+                        ELSE progress
                     END AS overall_progress
-                FROM latest_stage_progress sp
-                FULL OUTER JOIN latest_paper_progress pp ON sp.run_id = pp.run_id
+                FROM latest_progress
             ),
             artifact_counts AS (
                 SELECT run_id, COUNT(*) as count
@@ -584,16 +572,16 @@ class ResearchPipelineRunsMixin(ConnectionProvider):
                 iv.short_hypothesis AS idea_hypothesis,
                 u.name AS created_by_name,
                 u.id AS created_by_user_id,
-                lp.stage AS current_stage,
-                lp.overall_progress AS progress,
-                lp.best_metric,
+                pc.stage AS current_stage,
+                pc.overall_progress AS progress,
+                pc.best_metric,
                 COALESCE(ac.count, 0) AS artifacts_count,
                 i.conversation_id
             FROM research_pipeline_runs r
             JOIN ideas i ON r.idea_id = i.id
             JOIN idea_versions iv ON r.idea_version_id = iv.id
             JOIN users u ON i.created_by_user_id = u.id
-            LEFT JOIN latest_progress lp ON r.run_id = lp.run_id
+            LEFT JOIN progress_with_calculations pc ON r.run_id = pc.run_id
             LEFT JOIN artifact_counts ac ON r.run_id = ac.run_id
             {where_sql}
             ORDER BY r.created_at DESC

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I have a good understanding of the PR. Let me read a couple more files to be thorough and then compile my review feedback.</details></think>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/conversation/components/LaunchResearchButton.tsx</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/features/conversation/components/LaunchResearchButton.tsx
```

```
diff --git a/frontend/src/features/conversation/components/LaunchResearchButton.tsx b/frontend/src/features/conversation/components/LaunchResearchButton.tsx
new file mode 100644
index 0000000..dad05e2
--- /dev/null
+++ b/frontend/src/features/conversation/components/LaunchResearchButton.tsx
@@ -0,0 +1,44 @@
+import { CreateProjectModal } from "@/features/project-draft/components/CreateProjectModal";
+import { Button } from "@/shared/components/ui/button";
+import { useLaunchResearch } from "../hooks/useLaunchResearch";
+
+interface LaunchResearchButtonProps {
+  conversationId: number | null;
+  disabled?: boolean;
+}
+
+/**
+ * Button component for launching research from an idea
+ * Handles modal state and confirmation flow
+ */
+export function LaunchResearchButton({
+  conversationId,
+  disabled = false,
+}: LaunchResearchButtonProps) {
+  const {
+    isLaunchModalOpen,
+    setIsLaunchModalOpen,
+    isLaunching,
+    handleLaunchClick,
+    handleConfirmLaunch,
+  } = useLaunchResearch(conversationId);
+
+  return (
+    &lt;&gt;
+      &lt;Button
+        onClick={handleLaunchClick}
+        size="sm"
+        disabled={disabled || isLaunching}
+        aria-label="Launch research for this idea"
+      &gt;
+        Launch Research
+      &lt;/Button&gt;
+      &lt;CreateProjectModal
+        isOpen={isLaunchModalOpen}
+        onClose={() =&gt; setIsLaunchModalOpen(false)}
+        onConfirm={handleConfirmLaunch}
+        isLoading={isLaunching}
+      /&gt;
+    &lt;/&gt;
+  );
+}

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/date-utils.ts</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist && git diff main -- frontend/src/shared/lib/date-utils.ts
```

```
diff --git a/frontend/src/shared/lib/date-utils.ts b/frontend/src/shared/lib/date-utils.ts
index b778c9c..40b1e53 100644
--- a/frontend/src/shared/lib/date-utils.ts
+++ b/frontend/src/shared/lib/date-utils.ts
@@ -1,7 +1,7 @@
 /**
  * Shared date utility functions
  */
-import { formatDistanceToNow, format } from "date-fns";
+import { formatDistanceToNow, format, differenceInSeconds } from "date-fns";
 
 /**
  * Formats a date string as relative time (e.g., "2 hours ago")
@@ -57,3 +57,44 @@ export function formatBytes(bytes: number): string {
   const i = Math.floor(Math.log(bytes) / Math.log(k));
   return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
 }
+
+/**
+ * Formats the duration between two dates in short format (e.g., "2h 30m")
+ * @param startDate - ISO date string (start time)
+ * @param endDate - ISO date string (end time), defaults to current time if not provided
+ * @returns Formatted duration string (e.g., "2h 30m", "45m", "1h 15m")
+ */
+export function formatDuration(startDate: string, endDate?: string | null): string {
+  try {
+    const start = new Date(startDate);
+    const end = endDate ? new Date(endDate) : new Date();
+
+    // Handle invalid dates
+    if (isNaN(start.getTime()) || isNaN(end.getTime())) {
+      return "-";
+    }
+
+    // Calculate difference in seconds
+    const totalSeconds = differenceInSeconds(end, start);
+
+    // Handle negative or zero duration
+    if (totalSeconds &lt;= 0) {
+      return "0m";
+    }
+
+    // Calculate hours, minutes, seconds
+    const hours = Math.floor(totalSeconds / 3600);
+    const minutes = Math.floor((totalSeconds % 3600) / 60);
+    const seconds = totalSeconds % 60;
+
+    // Build result string with non-zero components only
+    const parts: string[] = [];
+    if (hours &gt; 0) parts.push(&#96;${hours}h&#96;);
+    if (minutes &gt; 0) parts.push(&#96;${minutes}m&#96;);
+    if (seconds &gt; 0 &amp;&amp; hours === 0 &amp;&amp; minutes === 0) parts.push(&#96;${seconds}s&#96;);
+
+    return parts.length &gt; 0 ? parts.join(" ") : "0m";
+  } catch {
+    return "-";
+  }
+}

```
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I have a comprehensive view of the PR. Let me check the formatDateTime function that's being used since I see it referenced in tree-viz-card but I want to see the full implementation.</details></think>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "formatDateTime" in "/Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/date-utils.ts" • 1 match</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/src/shared/lib/date-utils.ts` | `export function formatDateTime(dateString: string): string \{` | L39 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I have a comprehensive understanding of this PR. Let me compile my review feedback.</details></think>

---

Now I have a comprehensive understanding of the PR. Let me provide my review feedback.

---

## PR 119 (AUT-317) Code Review

### Overview
This is a substantial PR that adds **Full Tree view** functionality, improves the tree visualization system, enhances the "Launch Research" flow, fixes the "Stop Run" functionality, and adds various UX improvements. Overall the code quality is good, but I have some observations:

---

### ✅ What Looks Good

1. **Tree Merge Utils (`tree-merge-utils.ts`)** - Well-structured with clear zone calculation logic. Good separation of concerns.

2. **Node Type System (`tree-colors.ts`)** - Clean enum-based approach with centralized color configuration. The `getNodeType()` function is well-reasoned.

3. **`useLaunchResearch` Hook** - Good extraction of launch logic into a reusable hook with proper error handling for 402/400 errors.

4. **Stop Run Fix** - The idempotent stop behavior and SSE event publishing is a solid fix. Good defensive coding.

5. **Executor Restart Logic (`parallel_agent.py`)** - Smart fix for worker timeout handling with `_handle_worker_timeout` → `_restart_executor` pattern.

---

### ⚠️ Issues & Concerns

#### 1. **Potential Bug in `getStageBadge` Signature Change**

```tsx:frontend/src/features/research/utils/research-utils.tsx
export function getStageBadge(
  stage: string | null,
  status?: string | null,  // NEW parameter inserted in middle
  configs: StageBadgeConfig[] = DEFAULT_STAGE_CONFIGS
): ReactNode {
```

You added `status` as the **second parameter**. This is a breaking change for any existing callers that pass `configs` as the second argument. Check all usages of `getStageBadge` to ensure they're updated. A safer approach would be to add `status` as the third parameter with a default value, or use an options object.

#### 2. **Duplicated Stage Slug Extraction Logic**

`extractStageSlug` is defined in **two places**:
- `frontend/src/shared/lib/stage-utils.ts` (new utility file)
- `frontend/src/features/research/utils/research-utils.tsx` (inline `extractLeadingStageNumber`)

The `stage-utils.ts` version is more complete. Consider removing the inline version in `research-utils.tsx` and using the shared one.

#### 3. **SQL Query Duplication**

In `research_pipeline_runs.py`, there's significant duplication between `get_run_detail()` and `list_runs()`:

```python:server/app/services/database/research_pipeline_runs.py
# Same CTE logic appears twice
WITH all_progress AS (
    SELECT run_id, stage, progress, best_metric, created_at
    FROM rp_run_stage_progress_events
    UNION ALL
    ...
```

Consider extracting the shared CTE logic into a helper or SQL fragment.

#### 4. **Magic Numbers in Tree Viz Configuration**

```tsx:frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
const SINGLE_STAGE_VIEWBOX_HEIGHT = 100;
const ADDITIONAL_HEIGHT_PER_STAGE = 33;
const VIEWBOX_TO_PIXELS_RATIO = 5;
```

Good that these are constants with comments, but `33` and `5` feel arbitrary. Consider documenting why these specific values were chosen (perhaps in a comment or the PR description).

#### 5. **Inconsistent Stage ID Handling**

Multiple patterns for stage IDs throughout the codebase:
- `"Stage_1"` vs `"stage_1"` (case sensitivity)
- `"1_initial_implementation"` (backend format)
- `"Full_Tree"` (synthetic ID)

The code handles this with `.toLowerCase().includes()`, but it might be cleaner to normalize stage IDs consistently at the API boundary.

#### 6. **`eslint-disable` Comment for `any` Type**

```tsx:frontend/src/features/research/components/run-detail/tree-viz-card.tsx
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const payload = selectedViz.viz as any;
```

Since you have `MergedTreeVizPayload` defined, you could properly type this instead of using `any`.

#### 7. **Modal Accessibility**

The new `Modal.tsx` component lacks:
- `aria-modal="true"` attribute
- Focus trapping (focus can escape the modal)
- Return focus to trigger element on close

This is fine for now but worth noting for accessibility compliance.

---

### 🤔 Simplification Opportunities

#### 1. **`node-strategy-data.ts` Could Be Simplified**

This file is 211 lines of static data. Consider:
- Moving to a JSON/YAML file if it's purely configuration
- Or keeping it if you need the TypeScript typing benefits

#### 2. **`STAGE_SUMMARIES` and `STAGE_ID_TO_STAGE_KEY` in `tree-viz-card.tsx`**

These are closely related to stage config elsewhere. Consider consolidating stage metadata into a single source of truth (perhaps in `stage-utils.ts`).

#### 3. **Remove Unused Return Values**

In `useResearchRunDetails.ts`, you removed `isConnected`, `connectionError`, and `reconnect` from the return object—good cleanup! Double-check no consumers relied on these.

---

### 🐛 Potential Bugs

#### 1. **Zero-Based vs One-Based Node IDs**

```tsx:frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx
<h3 className="text-base font-semibold">
  {selectedNode.stageId
    ? `${stageLabel(selectedNode.stageId)}: Node ${selectedNode.originalNodeId + 1}`
    : `Node ${selectedNode.id + 1}`}
</h3>
```

You're adding `+ 1` to display node IDs as 1-based. Make sure this is consistent with how nodes are referenced elsewhere (logs, backend events, etc.).

#### 2. **Edge Case in `mergeTreeVizItems`**

```ts:frontend/src/shared/lib/tree-merge-utils.ts
const bestNodeLocalIdx = isBestArray?.findIndex(b => b === true) ?? -1;
if (bestNodeLocalIdx < 0) continue; // Skip if no best node
```

If no stage has a best node, inter-stage connections won't be created. Is this intended? The Full Tree view might look disconnected.

---

### 📝 Minor Nits

1. **Comment typo** in `tree-viz-viewer.tsx`:
   ```tsx
   // Reduced from 18 for better density
   ```
   The comment references "18" but the constant is `14`. Was it reduced from something else?

2. **Inconsistent button styling** - `NodeTypesLegend` and `NodeStrategyGuide` buttons look identical but are defined inline. Could extract a shared `SmallButton` component.

3. **`useIsClient` guard** - Good for SSR safety, but `NodeTypesLegend` and `NodeStrategyGuide` could potentially just render `null` children rather than `null` entirely if you want the button placeholder to show during hydration.

---

### Summary

**Overall: 👍 Looks good to merge with minor fixes**

The PR delivers significant functionality (Full Tree view, improved tree viz, better UX) with generally clean code. Key things to address:

1. ⚠️ Verify `getStageBadge` signature change doesn't break callers
2. 🧹 Consolidate duplicate `extractStageSlug` functions  
3. 🔍 Consider proper typing instead of `as any` for viz payload

Let me know if you'd like me to dig deeper into any specific area!

---

_**User (2025-12-23 14:45Z)**_

For the Issues & Concerns you raised do the following:
- 1. do as you suggest and check all usages to ensure they're updated if needed
- 2. use noly the shared one and remove the duplicate
- 3.extract the shared logic into a helper or SQL fragment
- 4. No need to add documentation, but ensure the constants are all grouped in the file (probably at the top) basically follow best practice for code reaxbility and future editability
- 5. Fix to ensure everything is just stage_1 i.e. update all instances of Stage_1 i.e. remove all toLowerCase calls and just ensure everything is lower case everywhere to simplify
- 6. I agree
- 7. not sure I understand this but if there's a simple fix go ahead

r.e. simplifcaiton opportunities I agree with everything you mentioned, please address

r.e. bugs - I agree it's confusing how the node ids work - once you're done with the issues above, remind me of this one and other potenital bugs or things that we should still fix 

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user wants me to address the issues I raised in my review. Let me create a todo list to track all the work and then start addressing each item.

1. Check all usages of `getStageBadge` to ensure they're updated
2. Remove duplicate `extractStageSlug` - use only the shared one
3. Extract shared SQL CTE logic into a helper
4. Group all constants at top of file for tree-viz-viewer.tsx
5. Normalize stage IDs to lowercase (stage_1 instead of Stage_1)
6. Fix the `as any` type issue
7. Fix modal accessibility issues

Simplification opportunities:
- node-strategy-data.ts could be simplified
- Consolidate STAGE_SUMMARIES and STAGE_ID_TO_STAGE_KEY
- Verify no consumers relied on removed return values

Let me start by creating a todo list and then begin working through these items.</details></think>

---

I'll work through all these issues systematically. Let me create a todo list and start addressing each item.

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Check getStageBadge usages and fix signature if needed
- [ ] Remove duplicate extractStageSlug, use shared version
- [ ] Extract shared SQL CTE logic into helper
- [ ] Group constants at top of tree-viz-viewer.tsx
- [ ] Normalize stage IDs to lowercase everywhere
- [ ] Fix 'as any' type issue in tree-viz-card.tsx
- [ ] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [ ] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "getStageBadge\(" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 2 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/src/features/research/utils/research-utils.tsx` | `export function getStageBadge(` | L196 |
| `frontend/src/features/research/components/research-board-card-body.tsx` | `\{getStageBadge(currentStage, status) \|\| (` | L53 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Good, `getStageBadge` is only called in one place (`research-board-card-body.tsx`) and it's already being called with both `stage` and `status` parameters. The signature change is fine. Let me verify the file to make sure.</details></think>

---

Good - `getStageBadge` is only called in one place and it's already passing `status`. Let me verify the call is correct:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/research-board-card-body.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "isConnected|connectionError|reconnect" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 55 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> \| null>(null);` | L157 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `const reconnectAttemptsRef = useRef(0);` | L158 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `if (reconnectTimeoutRef.current) \{` | L195 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `clearTimeout(reconnectTimeoutRef.current);` | L196 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `reconnectAttemptsRef.current = 0;` | L229 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `if (reconnectAttemptsRef.current < maxReconnectAttempts) \{` | L301 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 30000);` | L302 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `reconnectAttemptsRef.current++;` | L303 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | ``[Research Run SSE] Connection failed: $\{errorMessage\}. Reconnection attempt $\{reconnectAttemptsRef.current\}/$\{maxReconnectAttempts\} in $\{delay\}ms`` | L306 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `reconnectTimeoutRef.current = setTimeout(connect, delay);` | L308 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `"[Research Run SSE] Max reconnection attempts reached. Connection permanently lost."` | L312 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `onError?.("Max reconnection attempts reached. Please refresh the page.");` | L314 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `if (reconnectTimeoutRef.current) \{` | L344 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `clearTimeout(reconnectTimeoutRef.current);` | L345 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `if (reconnectTimeoutRef.current) \{` | L354 |
| `frontend/src/features/research/hooks/useResearchRunSSE.ts` | `clearTimeout(reconnectTimeoutRef.current);` | L355 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `const reconnectAttemptsRef = useRef(0);` | L19 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> \| null>(null);` | L21 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `if (reconnectTimeoutRef.current) \{` | L39 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `clearTimeout(reconnectTimeoutRef.current);` | L40 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `reconnectAttemptsRef.current = 0;` | L52 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `const attempts = reconnectAttemptsRef.current;` | L86 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `reconnectAttemptsRef.current = attempts + 1;` | L89 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `reconnectTimeoutRef.current = setTimeout(connect, delay);` | L90 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `if (reconnectTimeoutRef.current) \{` | L101 |
| `frontend/src/shared/hooks/useWalletBalance.ts` | `clearTimeout(reconnectTimeoutRef.current);` | L102 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `/** Enable auto-reconnection on connection loss */` | L39 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnect?: boolean;` | L40 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `/** Max reconnection attempts (default: 5) */` | L41 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `isConnected: boolean;` | L50 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `connectionError: string \| null;` | L52 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `/** Manually trigger reconnection */` | L53 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnect: () => void;` | L54 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `* - Error handling with optional reconnection` | L65 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `* const \{ isConnected, connectionError \} = useSSEStream(\{` | L82 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnect: shouldReconnect = false,` | L101 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `const [isConnected, setIsConnected] = useState(false);` | L105 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `const [connectionError, setConnectionError] = useState<string \| null>(null);` | L106 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `// Refs for cleanup and reconnection` | L108 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> \| null>(null);` | L110 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `const reconnectAttemptsRef = useRef(0);` | L111 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `if (reconnectTimeoutRef.current) \{` | L120 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `clearTimeout(reconnectTimeoutRef.current);` | L121 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnectTimeoutRef.current = null;` | L122 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnectAttemptsRef.current = 0;` | L151 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `// Handle reconnection with exponential backoff` | L192 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `if (shouldReconnect && reconnectAttemptsRef.current < maxReconnectAttempts) \{` | L193 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 30000);` | L194 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnectAttemptsRef.current++;` | L195 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnectTimeoutRef.current = setTimeout(connect, delay);` | L196 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `onError?.("Max reconnection attempts reached");` | L198 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnectAttemptsRef.current = 0;` | L235 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `isConnected,` | L240 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `connectionError,` | L241 |
| `frontend/src/shared/hooks/use-sse-stream.ts` | `reconnect: manualReconnect,` | L242 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
The search shows that `isConnected`, `connectionError`, and `reconnect` are internal implementation details of the SSE hooks, not the removed return values from `useResearchRunDetails`. Those removed values were using these hooks internally. Let me check for any direct usage of these from the `useResearchRunDetails` hook:</details></think>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "useResearchRunDetails" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 3 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/src/features/research/hooks/useResearchRunDetails.ts` | `export function useResearchRunDetails(\{` | L41 |
| `frontend/src/app/(dashboard)/research/[runId]/page.tsx` | `import \{ useResearchRunDetails \} from "@/features/research/hooks/useResearchRunDetails";` | L18 |
| `frontend/src/app/(dashboard)/research/[runId]/page.tsx` | `\} = useResearchRunDetails(\{ runId \});` | L47 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Good - the `useResearchRunDetails` hook is only used in one place and the destructured values don't include the removed ones (`isConnected`, `connectionError`, `reconnect`). The change is safe.

Now let me proceed with the fixes. Let me:
1. Mark item 1 (getStageBadge) as complete - it's already correctly used
2. Mark item 10 (verify removed return values) as complete - they're not used
3. Start working on item 2 - remove duplicate extractStageSlug</details></think>

---

Good - `getStageBadge` is correctly used, and the removed return values from `useResearchRunDetails` aren't used elsewhere. Let me update todos and start fixing the issues:

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [-] Remove duplicate extractStageSlug, use shared version
- [ ] Extract shared SQL CTE logic into helper
- [ ] Group constants at top of tree-viz-viewer.tsx
- [ ] Normalize stage IDs to lowercase everywhere
- [ ] Fix 'as any' type issue in tree-viz-card.tsx
- [ ] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/utils/research-utils.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/stage-utils.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I understand the situation better. There are two related but different functions:

1. `extractStageSlug` in `stage-utils.ts` - extracts the slug part (e.g., "initial_implementation" from "1_initial_implementation")
2. `extractLeadingStageNumber` in `research-utils.tsx` - extracts just the number (e.g., "1" from "1_initial_implementation")

These do different things but could potentially be consolidated. However, the user's request was to "use only the shared one and remove the duplicate". Looking more carefully, these aren't exactly duplicates - they have different purposes.

Let me check what `extractStageSlug` is used for to see if we need both:</details></think>

---

I see these functions do different things - `extractStageSlug` gets the slug part while `extractLeadingStageNumber` gets the number. Let me check where each is used to consolidate properly:

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "extractStageSlug|extractLeadingStageNumber" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 4 matches</summary>

Output mode: files_with_matches


| File |
|------|
| `frontend/src/features/research/utils/research-utils.tsx` |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` |
| `frontend/src/shared/lib/stage-utils.ts` |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me look at how these are used to understand if we can consolidate:</details></think>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "extractStageSlug|extractLeadingStageNumber" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 13 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/src/features/research/utils/research-utils.tsx` | `function extractLeadingStageNumber(stage: string): string \| null \{` | L23 |
| `frontend/src/features/research/utils/research-utils.tsx` | `const stageNumber = extractLeadingStageNumber(raw);` | L33 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `import \{ stageLabel, extractStageSlug, getSummaryText \} from "@/shared/lib/stage-utils";` | L6 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `summary => extractStageSlug(summary.stage) === stageKey` | L114 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `import \{ extractStageSlug, getSummaryText \} from "@/shared/lib/stage-utils";` | L12 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `const slug = extractStageSlug(node.stage);` | L120 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `const slug = extractStageSlug(progress.stage);` | L139 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `const matches = selections.filter(selection => extractStageSlug(selection.stage) === stageKey);` | L168 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `const matches = summaries.filter(summary => extractStageSlug(summary.stage) === stageKey);` | L183 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `const slug = extractStageSlug(progress.stage);` | L291 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `const slug = extractStageSlug(event.stage);` | L320 |
| `frontend/src/features/research/components/run-detail/research-pipeline-stages.tsx` | `globalLatestProgress && extractStageSlug(globalLatestProgress.stage) === stageKey;` | L327 |
| `frontend/src/shared/lib/stage-utils.ts` | `export function extractStageSlug(stageName: string): string \| null \{` | L27 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I see. `extractLeadingStageNumber` is only used internally in `research-utils.tsx` for `formatResearchStageName`. The shared `extractStageSlug` is used more broadly.

Since they do different things:
- `extractStageSlug`: extracts "initial_implementation" from "1_initial_implementation"  
- `extractLeadingStageNumber`: extracts "1" from "1_initial_implementation"

I should add `extractLeadingStageNumber` to `stage-utils.ts` as the shared utility, rename it to something cleaner like `extractStageNumber`, then use it from `research-utils.tsx`.

Let me do that:</details></think>

---

I see these functions serve different purposes. Let me consolidate by adding `extractStageNumber` to the shared `stage-utils.ts` and using it from `research-utils.tsx`:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/stage-utils.ts</summary>

**Chunk 1**
Lines added: 15, lines removed: 2

```diff
@@ -3,8 +3,21 @@
  /**
   * Convert stage ID to human-readable label
-  * Example: "Stage_1" → "Stage 1"
+  * Example: "stage_1" → "Stage 1"
   */
  export function stageLabel(stageId: string): string {
-   return stageId.replace("Stage_", "Stage ");
+   return stageId.replace("stage_", "Stage ");
+ }
+ 
+ /**
+  * Extract the leading stage number from a backend stage name
+  *
+  * Backend format: {stage_number}_{stage_slug}[_{substage_number}_{substage_slug}...]
+  * Examples:
+  *   "1_initial_implementation" → "1"
+  *   "5_paper_generation" → "5"
+  */
+ export function extractStageNumber(stageName: string): string | null {
+   const match = stageName.match(/^(\d+)(?:_|$)/);
+   return match?.[1] ?? null;
  }
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update `research-utils.tsx` to import and use the shared function:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/utils/research-utils.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -4,4 +4,5 @@
  import type { ReactNode } from "react";
  import { CheckCircle2, Clock, Loader2, AlertCircle } from "lucide-react";
+ import { extractStageNumber } from "@/shared/lib/stage-utils";
  
  /**
```

**Chunk 2**
Lines added: undefined, lines removed: 5

```diff
@@ -20,9 +21,4 @@
    "5": "5: Paper Generation",
  };
- 
- function extractLeadingStageNumber(stage: string): string | null {
-   const match = stage.match(/^(\d+)(?:_|$)/);
-   return match?.[1] ?? null;
- }
  
  export function formatResearchStageName(stage: string | null | undefined): string | null {
```

**Chunk 3**
Lines added: 1, lines removed: 1

```diff
@@ -31,5 +27,5 @@
    if (!raw) return null;
  
-   const stageNumber = extractLeadingStageNumber(raw);
+   const stageNumber = extractStageNumber(raw);
    if (stageNumber) return STAGE_LABEL_BY_NUMBER[stageNumber] ?? raw;
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Good, now let me mark this as complete and move on to extracting the SQL CTE logic.</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [-] Extract shared SQL CTE logic into helper
- [ ] Group constants at top of tree-viz-viewer.tsx
- [ ] Normalize stage IDs to lowercase everywhere
- [ ] Fix 'as any' type issue in tree-viz-card.tsx
- [ ] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/server/app/services/database/research_pipeline_runs.py</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I can see the duplicated SQL CTE logic between `get_enriched_research_pipeline_run` (lines 394-464) and `list_all_research_pipeline_runs` (lines 524-589). The shared CTE includes:1. `all_progress` - union of stage progress and paper generation events
2. `latest_progress` - distinct on run_id, ordered by created_at  
3. `progress_with_calculations` - calculates overall progress
4. `artifact_counts` - counts artifacts by run_idI'll extract this into a constant or helper function. Since it's SQL and we need to insert WHERE clauses, I'll use a function that generates the CTE portion.</details></think>

---

I'll extract the shared SQL CTE logic into a helper constant at the top of the file:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/server/app/services/database/research_pipeline_runs.py</summary>

**Chunk 1**
Lines added: 44, lines removed: undefined

```diff
@@ -12,4 +12,48 @@
  
  PIPELINE_RUN_STATUSES = ("pending", "running", "failed", "completed")
+ 
+ # Shared SQL CTE for calculating progress across pipeline runs.
+ # Combines stage progress and paper generation events, then calculates overall progress
+ # as completed-stages-only buckets (0, 0.2, 0.4, 0.6, 0.8, 1.0).
+ _PROGRESS_CTE_SQL = """
+     all_progress AS (
+         SELECT run_id, stage, progress, best_metric, created_at
+         FROM rp_run_stage_progress_events
+         UNION ALL
+         SELECT run_id, '5_paper_generation'::text, progress, NULL::text, created_at
+         FROM rp_paper_generation_events
+     ),
+     latest_progress AS (
+         SELECT DISTINCT ON (run_id)
+             run_id,
+             stage,
+             progress,
+             best_metric,
+             created_at
+         FROM all_progress
+         ORDER BY run_id, created_at DESC
+     ),
+     progress_with_calculations AS (
+         SELECT
+             run_id,
+             stage,
+             best_metric,
+             -- Calculate overall progress as completed-stages-only buckets.
+             -- If the *current* stage is incomplete, the displayed progress reflects
+             -- only the number of fully-completed stages (0, 0.2, 0.4, 0.6, 0.8, 1.0).
+             CASE
+                 WHEN stage ~ '^[1-5]_' THEN
+                     CAST(substring(stage FROM 1 FOR 1) AS numeric) * 0.2 -
+                     CASE WHEN progress &gt;= 1 THEN 0 ELSE 0.2 END
+                 ELSE progress
+             END AS overall_progress
+         FROM latest_progress
+     ),
+     artifact_counts AS (
+         SELECT run_id, COUNT(*) as count
+         FROM rp_artifacts
+         GROUP BY run_id
+     )
+ """
  
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I need to update the two methods to use this shared CTE. Let me update `get_enriched_research_pipeline_run` first:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/server/app/services/database/research_pipeline_runs.py</summary>

**Chunk 1**
Lines added: 2, lines removed: 39

```diff
@@ -436,43 +436,6 @@
          or None if not found.
          """
-         query = """
-             WITH all_progress AS (
-                 SELECT run_id, stage, progress, best_metric, created_at
-                 FROM rp_run_stage_progress_events
-                 UNION ALL
-                 SELECT run_id, '5_paper_generation'::text, progress, NULL::text, created_at
-                 FROM rp_paper_generation_events
-             ),
-             latest_progress AS (
-                 SELECT DISTINCT ON (run_id)
-                     run_id,
-                     stage,
-                     progress,
-                     best_metric,
-                     created_at
-                 FROM all_progress
-                 ORDER BY run_id, created_at DESC
-             ),
-             progress_with_calculations AS (
-                 SELECT
-                     run_id,
-                     stage,
-                     best_metric,
-                     -- Calculate overall progress as completed-stages-only buckets.
-                     -- If the *current* stage is incomplete, the displayed progress reflects
-                     -- only the number of fully-completed stages (0, 0.2, 0.4, 0.6, 0.8, 1.0).
-                     CASE
-                         WHEN stage ~ '^[1-5]_' THEN
-                             CAST(substring(stage FROM 1 FOR 1) AS numeric) * 0.2 -
-                             CASE WHEN progress &gt;= 1 THEN 0 ELSE 0.2 END
-                         ELSE progress
-                     END AS overall_progress
-                 FROM latest_progress
-             ),
-             artifact_counts AS (
-                 SELECT run_id, COUNT(*) as count
-                 FROM rp_artifacts
-                 GROUP BY run_id
-             )
+         query = f"""
+             WITH {_PROGRESS_CTE_SQL}
              SELECT
                  r.run_id,
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update the second method `list_all_research_pipeline_runs`:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/server/app/services/database/research_pipeline_runs.py</summary>

**Chunk 1**
Lines added: 1, lines removed: 38

```diff
@@ -530,42 +530,5 @@
  
          query = f"""
-             WITH all_progress AS (
-                 SELECT run_id, stage, progress, best_metric, created_at
-                 FROM rp_run_stage_progress_events
-                 UNION ALL
-                 SELECT run_id, '5_paper_generation'::text, progress, NULL::text, created_at
-                 FROM rp_paper_generation_events
-             ),
-             latest_progress AS (
-                 SELECT DISTINCT ON (run_id)
-                     run_id,
-                     stage,
-                     progress,
-                     best_metric,
-                     created_at
-                 FROM all_progress
-                 ORDER BY run_id, created_at DESC
-             ),
-             progress_with_calculations AS (
-                 SELECT
-                     run_id,
-                     stage,
-                     best_metric,
-                     -- Calculate overall progress as completed-stages-only buckets.
-                     -- If the *current* stage is incomplete, the displayed progress reflects
-                     -- only the number of fully-completed stages (0, 0.2, 0.4, 0.6, 0.8, 1.0).
-                     CASE
-                         WHEN stage ~ '^[1-5]_' THEN
-                             CAST(substring(stage FROM 1 FOR 1) AS numeric) * 0.2 -
-                             CASE WHEN progress &gt;= 1 THEN 0 ELSE 0.2 END
-                         ELSE progress
-                     END AS overall_progress
-                 FROM latest_progress
-             ),
-             artifact_counts AS (
-                 SELECT run_id, COUNT(*) as count
-                 FROM rp_artifacts
-                 GROUP BY run_id
-             )
+             WITH {_PROGRESS_CTE_SQL}
              SELECT
                  r.run_id,
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Good. Now let me move on to the next items. Let me update the todos and work on grouping constants at the top of tree-viz-viewer.tsx.</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [x] Extract shared SQL CTE logic into helper
- [-] Group constants at top of tree-viz-viewer.tsx
- [ ] Normalize stage IDs to lowercase everywhere
- [ ] Fix 'as any' type issue in tree-viz-card.tsx
- [ ] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
The constants are already grouped together near the top after the type definitions (lines 64-75). Let me move the spacing constants from inside the `renderStageSeparators` function to the top with the other constants to make them more visible and easier to edit. This also follows the pattern of having all configuration at the top.</details></think>

---

The main constants are already grouped, but there are more constants inside `renderStageSeparators`. Let me move those to the top:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

**Chunk 1**
Lines added: 20, lines removed: 11

```diff
@@ -62,16 +62,25 @@
  }
  
- const NODE_SIZE = 14; // Reduced from 18 for better density
- 
- // SVG sizing configuration
- // These values are calibrated to maintain good aspect ratio and readability:
- // - SINGLE_STAGE_VIEWBOX_HEIGHT: Base height for single-stage tree visualization
- // - ADDITIONAL_HEIGHT_PER_STAGE: Extra height per additional stage in Full Tree view
- //   (33 provides ~1.33x scaling per stage which maintains readable node density)
- // - VIEWBOX_TO_PIXELS_RATIO: Maps viewBox units to CSS pixels
- //   (5x multiplier means viewBox 100 → 500px, giving good resolution)
+ // =============================================================================
+ // SVG VISUALIZATION CONSTANTS
+ // =============================================================================
+ 
+ // Node appearance
+ const NODE_SIZE = 14;
+ 
+ // ViewBox sizing - calibrated for good aspect ratio and readability
  const SINGLE_STAGE_VIEWBOX_HEIGHT = 100;
- const ADDITIONAL_HEIGHT_PER_STAGE = 33;
- const VIEWBOX_TO_PIXELS_RATIO = 5;
+ const ADDITIONAL_HEIGHT_PER_STAGE = 33; // ~1.33x scaling per stage
+ const VIEWBOX_TO_PIXELS_RATIO = 5; // viewBox 100 → 500px
+ 
+ // Full Tree stage separator layout (in viewBox units)
+ const LABEL_OFFSET_FROM_TOP = 5.0; // First stage: offset from zone top
+ const LABEL_OFFSET_FROM_DIVIDER = 6.0; // Other stages: offset below divider
+ const DIVIDER_OFFSET = 2.0; // Offset from calculated position
+ const LABEL_BG_HEIGHT = 5;
+ const LABEL_BG_PADDING_TOP = 3.5;
+ 
+ // Stage ID constants
+ const FULL_TREE_STAGE_ID = "full_tree";
  
  export function TreeVizViewer({ viz, artifacts, stageId, bestNodeId }: Props) {
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I need to update the usages in the file to use the new constants and replace the hardcoded "Full_Tree" with the constant, and remove the local constant declarations inside renderStageSeparators.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 7

```diff
@@ -207,11 +207,4 @@
    const renderStageSeparators = () =&gt; {
      if (!isFullTree || zoneMetadata.length === 0) return null;
- 
-     // Spacing constants (in viewBox units)
-     const LABEL_OFFSET_FROM_TOP = 5.0; // First stage: offset from zone top
-     const LABEL_OFFSET_FROM_DIVIDER = 6.0; // Other stages: offset below divider
-     const DIVIDER_OFFSET = 2.0; // Offset from calculated position
-     const LABEL_BG_HEIGHT = 5;
-     const LABEL_BG_PADDING_TOP = 3.5;
  
      return (
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I need to update the `isFullTree` check to use the constant `FULL_TREE_STAGE_ID` instead of the hardcoded string "Full_Tree". Also need to update the JSX that checks for "Full_Tree".</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -135,5 +135,5 @@
    // Extract zone metadata for Full Tree view
    const zoneMetadata = (payload as { zoneMetadata?: StageZoneMetadata[] }).zoneMetadata ?? [];
-   const isFullTree = stageId === "Full_Tree";
+   const isFullTree = stageId === FULL_TREE_STAGE_ID;
  
    // Calculate dynamic viewBox height based on number of stages
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I need to update the NodeTypesLegend and NodeStrategyGuide references to use the constant:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -339,6 +339,6 @@
          &lt;/div&gt;
          &lt;div className="mt-2 flex gap-2"&gt;
-           &lt;NodeTypesLegend stageId={stageId === "Full_Tree" ? undefined : stageId} /&gt;
-           &lt;NodeStrategyGuide stageId={stageId === "Full_Tree" ? undefined : stageId} /&gt;
+           &lt;NodeTypesLegend stageId={isFullTree ? undefined : stageId} /&gt;
+           &lt;NodeStrategyGuide stageId={isFullTree ? undefined : stageId} /&gt;
          &lt;/div&gt;
        &lt;/div&gt;
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me move on to normalizing stage IDs to lowercase. I need to find all occurrences of "Stage_1", "Stage_2", etc. and change them to lowercase. Also need to update "Full_Tree" to "full_tree" everywhere.</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [x] Extract shared SQL CTE logic into helper
- [x] Group constants at top of tree-viz-viewer.tsx
- [-] Normalize stage IDs to lowercase everywhere
- [ ] Fix 'as any' type issue in tree-viz-card.tsx
- [ ] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "Stage_[1-4]|Full_Tree" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 6 matches</summary>

Output mode: files_with_matches


| File |
|------|
| `frontend/src/shared/lib/tree-merge-utils.ts` |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` |
| `frontend/src/types/research.ts` |
| `frontend/src/shared/lib/tree-colors.ts` |
| `frontend/src/shared/lib/node-strategy-data.ts` |
| `frontend/src/types/api.gen.ts` |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me look at each file to understand where the stage IDs are used and update them to lowercase:</details></think>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "Stage_[1-4]|Full_Tree|toLowerCase" in "/Users/jpbowler/code/ae/AE-Scientist/frontend" • 51 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/src/features/research/utils/research-utils.tsx` | `const matchedConfig = configs.find(config => stage.toLowerCase().includes(config.pattern));` | L217 |
| `frontend/src/features/research/utils/research-utils.tsx` | `return LOG_LEVEL_COLORS[level.toLowerCase()] ?? "text-slate-300";` | L248 |
| `frontend/src/shared/lib/tree-merge-utils.ts` | `* Sort stages in chronological order (Stage_1, Stage_2, Stage_3, Stage_4)` | L13 |
| `frontend/src/shared/lib/tree-merge-utils.ts` | `const order = ["Stage_1", "Stage_2", "Stage_3", "Stage_4"];` | L16 |
| `frontend/src/shared/lib/tree-merge-utils.ts` | `stage_id: "Full_Tree",` | L268 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `const FULL_TREE_ID = "Full_Tree";` | L17 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_1:` | L20 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_2:` | L22 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_3:` | L24 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_4:` | L26 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_1: "initial_implementation",` | L33 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_2: "baseline_tuning",` | L34 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_3: "creative_research",` | L35 |
| `frontend/src/features/research/components/run-detail/tree-viz-card.tsx` | `Stage_4: "ablation_studies",` | L36 |
| `frontend/src/types/research.ts` | `stage_id: "Full_Tree";` | L350 |
| `frontend/src/shared/lib/tree-colors.ts` | `// Normalize stage_id (e.g., "Stage_1" or "stage_1")` | L163 |
| `frontend/src/shared/lib/tree-colors.ts` | `const stageNum = stageId.toLowerCase().includes("stage_1")` | L164 |
| `frontend/src/shared/lib/tree-colors.ts` | `: stageId.toLowerCase().includes("stage_2")` | L166 |
| `frontend/src/shared/lib/tree-colors.ts` | `: stageId.toLowerCase().includes("stage_3")` | L168 |
| `frontend/src/shared/lib/tree-colors.ts` | `: stageId.toLowerCase().includes("stage_4")` | L170 |
| `frontend/src/shared/lib/node-strategy-data.ts` | `export type StageId = "Stage_1" \| "Stage_2" \| "Stage_3" \| "Stage_4";` | L37 |
| `frontend/src/shared/lib/node-strategy-data.ts` | `Stage_1: \{` | L40 |
| `frontend/src/shared/lib/node-strategy-data.ts` | `Stage_2: \{` | L101 |
| `frontend/src/shared/lib/node-strategy-data.ts` | `Stage_3: \{` | L135 |
| `frontend/src/shared/lib/node-strategy-data.ts` | `Stage_4: \{` | L171 |
| `frontend/src/types/api.gen.ts` | `* @description Stage identifier (Stage_1..Stage_4)` | L3529 |
| `frontend/src/features/project-draft/components/ArraySectionEditModal.tsx` | `setError(`At least one $\{itemLabel.toLowerCase()\} is required`);` | L73 |
| `frontend/src/features/project-draft/components/ArraySectionEditModal.tsx` | `placeholder=\{`Enter $\{itemLabel.toLowerCase()\} content...`\}` | L173 |
| `frontend/src/features/project-draft/components/ArraySectionEditModal.tsx` | `placeholder=\{`Enter $\{itemLabel.toLowerCase()\}...`\}` | L197 |
| `frontend/src/features/research/components/run-detail/research-logs-list.tsx` | `const level = log.level.toLowerCase();` | L37 |
| `frontend/src/features/project-draft/components/StringSection.tsx` | `aria-label=\{`Edit $\{title.toLowerCase()\}`\}` | L126 |
| `frontend/src/features/input-pipeline/components/ChatGptUrlInput.tsx` | `const urlLower = url.toLowerCase();` | L23 |
| `frontend/src/features/conversation/hooks/useConversationsFilter.ts` | `const lowerSearch = searchTerm.toLowerCase();` | L42 |
| `frontend/src/features/conversation/hooks/useConversationsFilter.ts` | `const title = conversation.title?.toLowerCase() \|\| "";` | L44 |
| `frontend/src/features/conversation/hooks/useConversationsFilter.ts` | `const ideaTitle = conversation.ideaTitle?.toLowerCase() \|\| "";` | L45 |
| `frontend/src/features/conversation/hooks/useConversationsFilter.ts` | `const ideaAbstract = conversation.ideaAbstract?.toLowerCase() \|\| "";` | L46 |
| `frontend/src/features/conversation/hooks/useConversationsFilter.ts` | `const userName = conversation.userName?.toLowerCase() \|\| "";` | L47 |
| `frontend/src/features/conversation/hooks/useConversationsFilter.ts` | `const userEmail = conversation.userEmail?.toLowerCase() \|\| "";` | L48 |
| `frontend/src/shared/lib/searchUtils.ts` | `.toLowerCase()` | L33 |
| `frontend/src/shared/lib/searchUtils.ts` | `.toLowerCase()` | L85 |
| `frontend/src/shared/lib/searchUtils.ts` | `const contentLower = content.toLowerCase();` | L93 |
| `frontend/src/shared/lib/searchUtils.ts` | `const queryLower = trimmed.toLowerCase();` | L221 |
| `frontend/src/shared/lib/fileUtils.ts` | `const extension = getFileExtension(file.name).toLowerCase();` | L32 |
| `frontend/src/features/model-selector/utils/modelUtils.ts` | `const searchText = filterText.toLowerCase().trim();` | L191 |
| `frontend/src/features/model-selector/utils/modelUtils.ts` | `const providerMatches = provider.toLowerCase().includes(searchText);` | L195 |
| `frontend/src/features/model-selector/utils/modelUtils.ts` | `model.label.toLowerCase().includes(searchText) \|\|` | L198 |
| `frontend/src/features/model-selector/utils/modelUtils.ts` | `model.id.toLowerCase().includes(searchText)` | L199 |
| `frontend/src/features/model-selector/components/ModelDropdown.tsx` | `const searchText = filterText.toLowerCase().trim();` | L62 |
| `frontend/src/features/model-selector/components/ModelDropdown.tsx` | `const providerMatches = provider.toLowerCase().includes(searchText);` | L63 |
| `frontend/src/features/model-selector/components/ModelDropdown.tsx` | `model.label.toLowerCase().includes(searchText) \|\|` | L66 |
| `frontend/src/features/model-selector/components/ModelDropdown.tsx` | `model.id.toLowerCase().includes(searchText)` | L67 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I have a list of all places that need to be updated. Let me start updating them. The key files are:

1. `tree-merge-utils.ts` - Stage_1..Stage_4 and Full_Tree
2. `tree-viz-card.tsx` - FULL_TREE_ID and STAGE_SUMMARIES keys
3. `tree-colors.ts` - Remove toLowerCase() calls and use lowercase directly
4. `node-strategy-data.ts` - StageId type and STAGE_STRATEGIES keys
5. `types/research.ts` - MergedTreeViz stage_id type

Let me start updating each file:</details></think>

---

Let me update each file to use lowercase stage IDs:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/tree-merge-utils.ts</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -11,8 +11,8 @@
  
  /**
-  * Sort stages in chronological order (Stage_1, Stage_2, Stage_3, Stage_4)
+  * Sort stages in chronological order (stage_1, stage_2, stage_3, stage_4)
   */
  function sortStages(items: TreeVizItem[]): TreeVizItem[] {
-   const order = ["Stage_1", "Stage_2", "Stage_3", "Stage_4"];
+   const order = ["stage_1", "stage_2", "stage_3", "stage_4"];
    return [...items].sort((a, b) =&gt; order.indexOf(a.stage_id) - order.indexOf(b.stage_id));
  }
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/tree-merge-utils.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -266,5 +266,5 @@
      id: -1, // Synthetic ID
      run_id: firstItem.run_id,
-     stage_id: "Full_Tree",
+     stage_id: "full_tree",
      version: 1,
      viz: merged,
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update tree-viz-card.tsx:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 5, lines removed: 5

```diff
@@ -15,14 +15,14 @@
  }
  
- const FULL_TREE_ID = "Full_Tree";
+ const FULL_TREE_ID = "full_tree";
  
  const STAGE_SUMMARIES: Record&lt;string, string&gt; = {
-   Stage_1:
+   stage_1:
      "Goal: Develop functional code which can produce a runnable result. The tree represents attempts and fixes needed to reach this state.",
-   Stage_2:
+   stage_2:
      "Goal: Improve the baseline through tuning and small changes to the code while keeping the overall approach fixed. The scientist tries to improve the metrics which quantify the quality of the research.",
-   Stage_3:
+   stage_3:
      "Goal: Explore higher-leverage variants and research directions, supported by plots and analyses to understand what is driving performance. The scientist tries to find and validate meaningful improvements worth writing up.",
-   Stage_4:
+   stage_4:
      "Goal: Run controlled ablations and robustness checks to isolate which components matter and why. The scientist tries to attribute gains and strengthen the evidence for the final claims.",
    [FULL_TREE_ID]:
```

**Chunk 2**
Lines added: 4, lines removed: 4

```diff
@@ -31,8 +31,8 @@
  
  const STAGE_ID_TO_STAGE_KEY: Record&lt;string, string&gt; = {
-   Stage_1: "initial_implementation",
-   Stage_2: "baseline_tuning",
-   Stage_3: "creative_research",
-   Stage_4: "ablation_studies",
+   stage_1: "initial_implementation",
+   stage_2: "baseline_tuning",
+   stage_3: "creative_research",
+   stage_4: "ablation_studies",
  };
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update tree-colors.ts to use lowercase directly and remove toLowerCase calls:</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/tree-colors.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I understand the pattern. Let me simplify this by using lowercase directly:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/tree-colors.ts</summary>

**Chunk 1**
Lines added: 4, lines removed: 16

```diff
@@ -161,21 +161,9 @@
    if (!stageId) return Object.values(NodeType);
  
-   // Normalize stage_id (e.g., "Stage_1" or "stage_1")
-   const stageNum = stageId.toLowerCase().includes("stage_1")
-     ? 1
-     : stageId.toLowerCase().includes("stage_2")
-       ? 2
-       : stageId.toLowerCase().includes("stage_3")
-         ? 3
-         : stageId.toLowerCase().includes("stage_4")
-           ? 4
-           : null;
- 
-   if (!stageNum) return Object.values(NodeType);
- 
-   switch (stageNum) {
-     case 1:
+   // Stage IDs are expected in lowercase format (stage_1, stage_2, etc.)
+   switch (stageId) {
+     case "stage_1":
        return [NodeType.Root, NodeType.Debug, NodeType.Improve, NodeType.SeedNode];
-     case 2:
+     case "stage_2":
        return [
          NodeType.Root,
```

**Chunk 2**
Lines added: 2, lines removed: 2

```diff
@@ -185,7 +173,7 @@
          NodeType.SeedNode,
        ];
-     case 3:
+     case "stage_3":
        return [NodeType.Debug, NodeType.Improve, NodeType.SeedNode];
-     case 4:
+     case "stage_4":
        return [NodeType.Improve, NodeType.Ablation, NodeType.SeedNode];
      default:
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update node-strategy-data.ts:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/node-strategy-data.ts</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -35,8 +35,8 @@
  }
  
- export type StageId = "Stage_1" | "Stage_2" | "Stage_3" | "Stage_4";
+ export type StageId = "stage_1" | "stage_2" | "stage_3" | "stage_4";
  
  export const STAGE_STRATEGIES: Record&lt;StageId, StageStrategy&gt; = {
-   Stage_1: {
+   stage_1: {
      title: "Stage 1: Baseline Implementation",
      goal: "Develop functional code which can produce a runnable result",
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update the other Stage_ entries in node-strategy-data.ts:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/node-strategy-data.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -99,5 +99,5 @@
    },
  
-   Stage_2: {
+   stage_2: {
      title: "Stage 2: Baseline Tuning",
      goal: "Improve baseline through hyperparameter optimization",
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/node-strategy-data.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -133,5 +133,5 @@
    },
  
-   Stage_3: {
+   stage_3: {
      title: "Stage 3: Creative Exploration",
      goal: "Explore higher-leverage variants with supporting analysis",
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/node-strategy-data.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -169,5 +169,5 @@
    },
  
-   Stage_4: {
+   stage_4: {
      title: "Stage 4: Ablation Studies",
      goal: "Run controlled ablations to understand component contributions",
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update types/research.ts:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/types/research.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -348,5 +348,5 @@
  
  export interface MergedTreeViz extends Omit&lt;TreeVizItem, "stage_id" | "viz"&gt; {
-   stage_id: "Full_Tree";
+   stage_id: "full_tree";
    viz: MergedTreeVizPayload;
  }
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I need to update the stageLabel function in stage-utils.ts to handle lowercase:</details></think>

---

Now let me also update the `stageLabel` function to handle lowercase format:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/stage-utils.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
The stageLabel function already handles lowercase format correctly (it converts "stage_1" to "Stage 1"). Good.

Now let me move on to fixing the `as any` type issue and the other items.</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [x] Extract shared SQL CTE logic into helper
- [x] Group constants at top of tree-viz-viewer.tsx
- [x] Normalize stage IDs to lowercase everywhere
- [-] Fix 'as any' type issue in tree-viz-card.tsx
- [ ] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I see the `as any` issue on line 92. The problem is that `selectedViz.viz` could be either `TreeVizItem["viz"]` or `MergedTreeVizPayload`, and we need to access the `is_best_node` property. Let me create a proper type for this.

Looking at the types, both `TreeVizItem["viz"]` (which is `Record<string, unknown>`) and `MergedTreeVizPayload` (which has explicit typing) can have `is_best_node`. The issue is that `TreeVizItem["viz"]` is typed as `Record<string, unknown>`.

I'll create a type assertion that's more specific:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 3

```diff
@@ -89,7 +89,6 @@
      }
  
-     // eslint-disable-next-line @typescript-eslint/no-explicit-any
-     const payload = selectedViz.viz as any;
-     const isBestNodeArray = payload?.is_best_node;
+     const payload = selectedViz.viz as { is_best_node?: boolean[] };
+     const isBestNodeArray = payload.is_best_node;
  
      if (!isBestNodeArray || isBestNodeArray.length === 0) {
```

**Chunk 2**
Lines added: 1, lines removed: 1

```diff
@@ -98,5 +97,5 @@
  
      // Find the index where is_best_node is true
-     const bestNodeIndex = isBestNodeArray.findIndex((isBest: boolean) =&gt; isBest === true);
+     const bestNodeIndex = isBestNodeArray.findIndex(isBest =&gt; isBest === true);
  
      return bestNodeIndex &gt;= 0 ? bestNodeIndex : null;
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me move on to the modal accessibility improvements:</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [x] Extract shared SQL CTE logic into helper
- [x] Group constants at top of tree-viz-viewer.tsx
- [x] Normalize stage IDs to lowercase everywhere
- [x] Fix 'as any' type issue in tree-viz-card.tsx
- [-] Add basic modal accessibility improvements
- [ ] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [ ] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/components/Modal.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I'll add basic accessibility improvements:
1. `role="dialog"` and `aria-modal="true"` on the dialog
2. `aria-labelledby` to associate the title with the dialog
3. Click on backdrop to close</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/components/Modal.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -1,5 +1,5 @@
  "use client";
  
- import { useEffect, ReactNode } from "react";
+ import { useEffect, useId, ReactNode, useCallback } from "react";
  import { createPortal } from "react-dom";
  import { X } from "lucide-react";
```

**Chunk 2**
Lines added: 1, lines removed: 1

```diff
@@ -15,5 +15,5 @@
  
  /**
-  * Reusable modal dialog component with escape key handling
+  * Reusable modal dialog component with escape key handling and accessibility
   */
  export function Modal({
```

**Chunk 3**
Lines added: 2, lines removed: undefined

```diff
@@ -25,4 +25,6 @@
    maxHeight = "max-h-96",
  }: ModalProps) {
+   const titleId = useId();
+ 
    useEffect(() =&gt; {
      if (!isOpen) return;
```

**Chunk 4**
Lines added: 17, lines removed: 1

```diff
@@ -37,10 +39,26 @@
      return () =&gt; document.removeEventListener("keydown", handleEscape);
    }, [isOpen, onClose]);
+ 
+   const handleBackdropClick = useCallback(
+     (e: React.MouseEvent&lt;HTMLDivElement&gt;) =&gt; {
+       if (e.target === e.currentTarget) {
+         onClose();
+       }
+     },
+     [onClose]
+   );
  
    if (!isOpen) return null;
  
    return createPortal(
-     &lt;div className="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/50"&gt;
+     &lt;div
+       className="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/50"
+       onClick={handleBackdropClick}
+       role="presentation"
+     &gt;
        &lt;div
+         role="dialog"
+         aria-modal="true"
+         aria-labelledby={titleId}
          className={&#96;relative rounded-lg border border-slate-700 bg-slate-800 p-6 shadow-xl ${maxWidth} w-full ${maxHeight} overflow-y-auto&#96;}
        &gt;
```

**Chunk 5**
Lines added: 4, lines removed: 2

```diff
@@ -49,9 +67,11 @@
            onClick={onClose}
            className="absolute top-4 right-4 p-1 hover:bg-slate-700 rounded transition-colors flex-shrink-0"
-           title="Close modal"
+           aria-label="Close modal"
          &gt;
            &lt;X className="w-4 h-4 text-slate-400" /&gt;
          &lt;/button&gt;
-         &lt;h2 className="text-lg font-semibold text-slate-100 mb-4 pr-6"&gt;{title}&lt;/h2&gt;
+         &lt;h2 id={titleId} className="text-lg font-semibold text-slate-100 mb-4 pr-6"&gt;
+           {title}
+         &lt;/h2&gt;
          {children}
        &lt;/div&gt;
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me work on consolidating STAGE_SUMMARIES and STAGE_ID_TO_STAGE_KEY. Since these are stage-related constants, I should move them to `stage-utils.ts` and also consolidate node-strategy-data.ts.For the consolidation, I'll:1. Move STAGE_SUMMARIES and STAGE_ID_TO_STAGE_KEY to stage-utils.ts
2. Update tree-viz-card.tsx to import from there3. Consider if node-strategy-data.ts should also import these or be consolidatedLet me first add these to stage-utils.ts:</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [x] Extract shared SQL CTE logic into helper
- [x] Group constants at top of tree-viz-viewer.tsx
- [x] Normalize stage IDs to lowercase everywhere
- [x] Fix 'as any' type issue in tree-viz-card.tsx
- [x] Add basic modal accessibility improvements
- [-] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [-] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
I'll consolidate the stage-related constants into `stage-utils.ts` and update the files that use them. Then I'll look at simplifying `node-strategy-data.ts`.</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/stage-utils.ts</summary>

**Chunk 1**
Lines added: 36, lines removed: undefined

```diff
@@ -1,3 +1,39 @@
  import type { SubstageSummary } from "@/types/research";
+ 
+ // =============================================================================
+ // STAGE CONSTANTS
+ // =============================================================================
+ 
+ export const FULL_TREE_STAGE_ID = "full_tree";
+ 
+ /**
+  * Stage goal descriptions shown in the Tree Visualization UI
+  */
+ export const STAGE_SUMMARIES: Record&lt;string, string&gt; = {
+   stage_1:
+     "Goal: Develop functional code which can produce a runnable result. The tree represents attempts and fixes needed to reach this state.",
+   stage_2:
+     "Goal: Improve the baseline through tuning and small changes to the code while keeping the overall approach fixed. The scientist tries to improve the metrics which quantify the quality of the research.",
+   stage_3:
+     "Goal: Explore higher-leverage variants and research directions, supported by plots and analyses to understand what is driving performance. The scientist tries to find and validate meaningful improvements worth writing up.",
+   stage_4:
+     "Goal: Run controlled ablations and robustness checks to isolate which components matter and why. The scientist tries to attribute gains and strengthen the evidence for the final claims.",
+   [FULL_TREE_STAGE_ID]:
+     "Combined view showing all stages of the research pipeline stacked vertically in chronological order.",
+ };
+ 
+ /**
+  * Maps frontend stage IDs (stage_1, etc.) to backend stage slugs (initial_implementation, etc.)
+  */
+ export const STAGE_ID_TO_SLUG: Record&lt;string, string&gt; = {
+   stage_1: "initial_implementation",
+   stage_2: "baseline_tuning",
+   stage_3: "creative_research",
+   stage_4: "ablation_studies",
+ };
+ 
+ // =============================================================================
+ // STAGE UTILITY FUNCTIONS
+ // =============================================================================
  
  /**
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now update tree-viz-card.tsx to use these constants from stage-utils.ts:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 8, lines removed: 1

```diff
@@ -4,5 +4,12 @@
  import type { TreeVizItem, ArtifactMetadata, SubstageSummary } from "@/types/research";
  import { formatDateTime } from "@/shared/lib/date-utils";
- import { stageLabel, extractStageSlug, getSummaryText } from "@/shared/lib/stage-utils";
+ import {
+   stageLabel,
+   extractStageSlug,
+   getSummaryText,
+   FULL_TREE_STAGE_ID,
+   STAGE_SUMMARIES,
+   STAGE_ID_TO_SLUG,
+ } from "@/shared/lib/stage-utils";
  import { TreeVizViewer } from "./tree-viz-viewer";
  import { mergeTreeVizItems } from "@/shared/lib/tree-merge-utils";
```

**Chunk 2**
Lines added: undefined, lines removed: 22

```diff
@@ -14,26 +21,4 @@
    substageSummaries?: SubstageSummary[];
  }
- 
- const FULL_TREE_ID = "full_tree";
- 
- const STAGE_SUMMARIES: Record&lt;string, string&gt; = {
-   stage_1:
-     "Goal: Develop functional code which can produce a runnable result. The tree represents attempts and fixes needed to reach this state.",
-   stage_2:
-     "Goal: Improve the baseline through tuning and small changes to the code while keeping the overall approach fixed. The scientist tries to improve the metrics which quantify the quality of the research.",
-   stage_3:
-     "Goal: Explore higher-leverage variants and research directions, supported by plots and analyses to understand what is driving performance. The scientist tries to find and validate meaningful improvements worth writing up.",
-   stage_4:
-     "Goal: Run controlled ablations and robustness checks to isolate which components matter and why. The scientist tries to attribute gains and strengthen the evidence for the final claims.",
-   [FULL_TREE_ID]:
-     "Combined view showing all stages of the research pipeline stacked vertically in chronological order.",
- };
- 
- const STAGE_ID_TO_STAGE_KEY: Record&lt;string, string&gt; = {
-   stage_1: "initial_implementation",
-   stage_2: "baseline_tuning",
-   stage_3: "creative_research",
-   stage_4: "ablation_studies",
- };
  
  export function TreeVizCard({ treeViz, conversationId, artifacts, substageSummaries }: Props) {
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now I need to update the usages in tree-viz-card.tsx to use the new constant names:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -44,6 +44,6 @@
      // If user has manually selected Full Tree or a stage that still exists, use it
      if (manuallySelectedStageId) {
-       if (manuallySelectedStageId === FULL_TREE_ID) {
-         return FULL_TREE_ID;
+       if (manuallySelectedStageId === FULL_TREE_STAGE_ID) {
+         return FULL_TREE_STAGE_ID;
        }
        if (list.find(v =&gt; v.stage_id === manuallySelectedStageId)) {
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Continue updating the other references:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -64,5 +64,5 @@
    const selectedViz = useMemo(() =&gt; {
      if (!hasViz || !selectedStageId) return null;
-     if (selectedStageId === FULL_TREE_ID) return mergedViz;
+     if (selectedStageId === FULL_TREE_STAGE_ID) return mergedViz;
      return list.find(v =&gt; v.stage_id === selectedStageId) ?? list[0];
    }, [hasViz, selectedStageId, list, mergedViz]);
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -90,7 +90,7 @@
      if (!selectedViz) return null;
      if (!substageSummaries || substageSummaries.length === 0) return null;
-     if (selectedViz.stage_id === FULL_TREE_ID) return null;
+     if (selectedViz.stage_id === FULL_TREE_STAGE_ID) return null;
  
-     const stageKey = STAGE_ID_TO_STAGE_KEY[selectedViz.stage_id];
+     const stageKey = STAGE_ID_TO_SLUG[selectedViz.stage_id];
      if (!stageKey) return null;
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -138,8 +138,8 @@
                type="button"
                onClick={() =&gt; {
-                 setManuallySelectedStageId(FULL_TREE_ID);
+                 setManuallySelectedStageId(FULL_TREE_STAGE_ID);
                }}
                className={&#96;rounded px-3 py-1 text-xs ${
-                 selectedStageId === FULL_TREE_ID
+                 selectedStageId === FULL_TREE_STAGE_ID
                    ? "bg-emerald-500 text-slate-900"
                    : "bg-slate-800 text-slate-200 hover:bg-slate-700"
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me also update the tree-viz-viewer.tsx to import FULL_TREE_STAGE_ID from stage-utils.ts instead of having its own constant:</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -4,5 +4,5 @@
  import type { ArtifactMetadata, TreeVizItem, MergedTreeViz, StageZoneMetadata } from "@/types/research";
  import { fetchDownloadUrl } from "@/shared/lib/downloads";
- import { stageLabel } from "@/shared/lib/stage-utils";
+ import { stageLabel, FULL_TREE_STAGE_ID } from "@/shared/lib/stage-utils";
  import {
    getNodeType,
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 2

```diff
@@ -81,6 +81,4 @@
  const LABEL_BG_PADDING_TOP = 3.5;
  
- // Stage ID constants
- const FULL_TREE_STAGE_ID = "full_tree";
  
  export function TreeVizViewer({ viz, artifacts, stageId, bestNodeId }: Props) {
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
Now let me check the node-strategy-data.ts file. I mentioned simplifying it, but since it's TypeScript with proper typing, it makes sense to keep it as TS. However, I should consider moving the SEARCH_CONFIG reference somewhere central if it's used elsewhere, or keep it as is since it documents the config values.Let me check if node-strategy-data.ts can be simplified by consolidating with stage-utils.ts or if it should remain separate:</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/node-strategy-data.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
The node-strategy-data.ts file is well-structured and serves a specific purpose (providing strategy guide content for the UI). It's not really a candidate for moving to JSON because it uses template strings with computed values from SEARCH_CONFIG. It should remain as TypeScript.However, I can export the StageId type from stage-utils.ts instead of duplicating it in node-strategy-data.ts. Actually, the StageId type in node-strategy-data.ts is a specific subset, so it should stay there.Let me update todos to reflect that simplifying node-strategy-data.ts isn't needed - it's already well-organized. The consolidation of STAGE_SUMMARIES is done.Let me check for lint errors in all the files I've modified:</details></think>

---

The `node-strategy-data.ts` file is actually well-organized as TypeScript since it uses template strings with computed values. It should remain as is. Let me complete the todos and check for lint errors:

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Check getStageBadge usages and fix signature if needed
- [x] Remove duplicate extractStageSlug, use shared version
- [x] Extract shared SQL CTE logic into helper
- [x] Group constants at top of tree-viz-viewer.tsx
- [x] Normalize stage IDs to lowercase everywhere
- [x] Fix 'as any' type issue in tree-viz-card.tsx
- [x] Add basic modal accessibility improvements
- [x] Simplify node-strategy-data.ts (move to JSON or consolidate)
- [x] Consolidate STAGE_SUMMARIES/STAGE_ID_TO_STAGE_KEY
- [x] Verify removed hook return values aren't used elsewhere

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 8 files</summary>
      
Lint paths:

- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/stage-utils.ts`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/tree-merge-utils.ts`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/tree-colors.ts`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-card.tsx`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/components/run-detail/tree-viz-viewer.tsx`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/components/Modal.tsx`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/features/research/utils/research-utils.tsx`
- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/types/research.ts`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
All lint errors are cleared. Let me run lint checks on a few more files I modified and also check the Python file:</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `/Users/jpbowler/code/ae/AE-Scientist/frontend/src/shared/lib/node-strategy-data.ts`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist/server && uv run ruff check app/services/database/research_pipeline_runs.py</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist/server && uv run ruff check app/services/database/research_pipeline_runs.py
```

```
All checks passed!

```
</details>
</tool-use>

---

Let me run a quick TypeScript compile check on the frontend:

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd /Users/jpbowler/code/ae/AE-Scientist/frontend && npx tsc --noEmit 2>&1 | head -50</summary>

```bash
cd /Users/jpbowler/code/ae/AE-Scientist/frontend && npx tsc --noEmit 2>&1 | head -50
```
</details>
</tool-use>

---

All changes compile successfully. Let me provide a summary of what was done and remind you of the remaining items:

---

## Summary of Changes Made

### ✅ All Issues Fixed

1. **`getStageBadge` signature** - Verified all usages are correct (only 1 call site, already updated)

2. **Removed duplicate `extractStageSlug`** - Added `extractStageNumber` to shared `stage-utils.ts` and updated `research-utils.tsx` to use it

3. **Extracted shared SQL CTE logic** - Created `_PROGRESS_CTE_SQL` constant at the top of `research_pipeline_runs.py`, used by both `get_enriched_research_pipeline_run()` and `list_all_research_pipeline_runs()`

4. **Grouped constants at top of `tree-viz-viewer.tsx`** - Moved all constants (including stage separator layout constants) to the top with a section header

5. **Normalized stage IDs to lowercase** - Changed all instances:
   - `Stage_1` → `stage_1` (etc.)
   - `Full_Tree` → `full_tree`
   - Removed all `toLowerCase()` calls since everything is now consistently lowercase

6. **Fixed `as any` type issue** - Changed `as any` to `as { is_best_node?: boolean[] }` in `tree-viz-card.tsx`

7. **Added modal accessibility** - Added `role="dialog"`, `aria-modal="true"`, `aria-labelledby`, `aria-label` for close button, and backdrop click-to-close

### ✅ Simplification Opportunities Addressed

8. **`node-strategy-data.ts`** - Reviewed and determined it should stay as TypeScript since it uses computed values from `SEARCH_CONFIG` in template strings

9. **Consolidated `STAGE_SUMMARIES`/`STAGE_ID_TO_STAGE_KEY`** - Moved both to `stage-utils.ts` as `STAGE_SUMMARIES` and `STAGE_ID_TO_SLUG`, exported `FULL_TREE_STAGE_ID` as well

10. **Verified removed hook return values** - Confirmed `isConnected`, `connectionError`, `reconnect` from `useResearchRunDetails` are not used elsewhere

---

## 🔴 Remaining Items to Discuss

### Potential Bug: Zero-Based vs One-Based Node IDs

In `tree-viz-viewer.tsx`:

```tsx
<h3 className="text-base font-semibold">
  {selectedNode.stageId
    ? `${stageLabel(selectedNode.stageId)}: Node ${selectedNode.originalNodeId + 1}`
    : `Node ${selectedNode.id + 1}`}
</h3>
```

**The issue:** Node IDs are displayed as 1-indexed (adding `+ 1`) for user-friendliness, but:
- Internal arrays are 0-indexed
- If logs or backend events reference node indices, they may be 0-indexed
- This could cause confusion when users try to cross-reference nodes

**Recommendation:** Decide on a convention and document it, or ensure backend events also use 1-indexed display IDs.

### Edge Case in `mergeTreeVizItems`

In `tree-merge-utils.ts`:

```ts
const bestNodeLocalIdx = isBestArray?.findIndex(b => b === true) ?? -1;
if (bestNodeLocalIdx < 0) continue; // Skip if no best node
```

**The issue:** If a stage has no best node marked, inter-stage connections won't be created, resulting in a disconnected Full Tree view.

**Recommendation:** Consider falling back to connecting to the root node of the next stage if no best node exists, or display a warning in the UI.

### Minor: Comment Inconsistency

The comment `// Reduced from 18 for better density` references "18" but `NODE_SIZE = 14`. The original value may have been different. Consider updating the comment or removing it.

---

